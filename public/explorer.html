<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Browse Moments – Chunky's NFLAD Viewer</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="stylesheet" href="/header.css" />
        <style>
            :root {
                --bg: #050815;
                --bg-elevated: #0b1020;
                --bg-elevated-soft: #101526;
                --border-soft: #1b2236;
                --text: #f8f9ff;
                --text-muted: #8c95b8;
                --accent: #6f42c1;
                --accent2: #007bff;
                --accent-soft: rgba(111, 66, 193, 0.18);
                --radius-lg: 16px;
                --radius-md: 12px;
            }

            * {
                box-sizing: border-box;
            }

            body {
                margin: 0;
                padding: 0;
                font-family:
                    system-ui,
                    -apple-system,
                    BlinkMacSystemFont,
                    "Segoe UI",
                    sans-serif;
                background: radial-gradient(circle at top, #101526 0, #050815 55%);
                color: var(--text);
            }

            a {
                color: var(--accent2);
                text-decoration: none;
            }

            a:hover {
                text-decoration: underline;
            }

            /* Header / nav */

            /* Header styles are in /header.css */

            /* Layout */

            main.app-main {
                max-width: 1800px;
                margin: 1.5rem auto 2.5rem;
                padding: 0 1.5rem;
            }

            .page-title {
                font-size: 1.15rem;
                font-weight: 600;
                margin-bottom: 0.25rem;
            }

            .page-subtitle {
                font-size: 0.85rem;
                color: var(--text-muted);
                margin-bottom: 1.25rem;
            }

            .layout-two-column {
                display: grid;
                grid-template-columns: 260px minmax(0, 1fr);
                gap: 1.5rem;
                align-items: flex-start;
            }

            /* Filters card */

            .filters-card {
                background: radial-gradient(circle at top left, #171d34 0, #050915 55%);
                border-radius: var(--radius-lg);
                border: 1px solid var(--border-soft);
                padding: 1.2rem;
                box-shadow: 0 18px 40px rgba(0, 0, 0, 0.5);
            }

            .filters-title {
                font-size: 0.95rem;
                font-weight: 600;
                margin-bottom: 0.75rem;
            }

            .filters-help {
                font-size: 0.78rem;
                color: var(--text-muted);
                margin-bottom: 0.9rem;
            }

            .filter-group {
                margin-bottom: 0.7rem;
            }

            .filter-label {
                font-size: 0.78rem;
                text-transform: uppercase;
                letter-spacing: 0.08em;
                margin-bottom: 0.2rem;
                color: var(--text-muted);
            }

            .filter-select {
                width: 100%;
                background: #050a18;
                border-radius: 10px;
                border: 1px solid var(--border-soft);
                padding: 0.4rem 0.65rem;
                color: var(--text);
                font-size: 0.85rem;
                outline: none;
            }

            .filters-actions {
                display: flex;
                gap: 0.5rem;
                margin-top: 0.8rem;
            }

            .btn-secondary {
                border-radius: 999px;
                border: 1px solid var(--border-soft);
                padding: 0.4rem 0.9rem;
                background: transparent;
                color: var(--text-muted);
                font-size: 0.8rem;
                cursor: pointer;
            }

            .btn-secondary:hover {
                border-color: var(--accent);
                color: var(--accent2);
            }

            .expand-icon {
                color: var(--text-muted);
                font-size: 0.7rem;
                display: inline-block;
                width: 16px;
            }

            tr[style*="cursor: pointer"]:hover {
                background: rgba(111, 66, 193, 0.1);
            }

            .edition-moments-row {
                background: rgba(15, 23, 42, 0.3);
            }

            /* Results */

            .results-card {
                background: #050915;
                border-radius: var(--radius-lg);
                border: 1px solid var(--border-soft);
                overflow: hidden;
            }

            .results-header {
                padding: 0.9rem 1.3rem;
                border-bottom: 1px solid var(--border-soft);
                display: flex;
                justify-content: space-between;
                align-items: baseline;
                gap: 0.75rem;
            }

            .results-title {
                font-size: 0.95rem;
                font-weight: 600;
            }

            .results-subtitle {
                font-size: 0.8rem;
                color: var(--text-muted);
            }

            .results-body {
                padding: 0.9rem 1.3rem 1.2rem;
            }

            .empty-state {
                font-size: 0.83rem;
                color: var(--text-muted);
                margin-bottom: 0.6rem;
            }

            .table-container {
                max-height: 70vh;
                overflow: auto;
                border-radius: var(--radius-md);
                border: 1px solid var(--border-soft);
                background: #050815;
            }

            table.table {
                width: 100%;
                border-collapse: collapse;
                font-size: 0.78rem;
            }

            table.table th,
            table.table td {
                padding: 0.35rem 0.5rem;
                font-size: 0.75rem;
            }

            table.table td {
                white-space: nowrap;
            }

            table.table thead {
                position: sticky;
                top: 0;
                background: #0b1020;
                z-index: 1;
            }

            table.table th {
                text-align: left;
                font-weight: 500;
                color: var(--text-muted);
                border-bottom: 1px solid var(--border-soft);
            }

            table.table th.sortable {
                cursor: pointer;
                user-select: none;
                position: relative;
                padding-right: 1.5rem;
            }

            table.table th.sortable:hover {
                background: rgba(111, 66, 193, 0.1);
                color: var(--text);
            }

            table.table th.sortable::after {
                content: "⇅";
                position: absolute;
                right: 0.4rem;
                opacity: 0.3;
                font-size: 0.7rem;
            }

            table.table th.sortable.sort-asc::after {
                content: "↑";
                opacity: 1;
                color: var(--accent2);
            }

            table.table th.sortable.sort-desc::after {
                content: "↓";
                opacity: 1;
                color: var(--accent2);
            }

            table.table tbody tr:nth-child(even) {
                background: rgba(255, 255, 255, 0.01);
            }

            table.table td {
                border-bottom: 1px solid rgba(255, 255, 255, 0.01);
            }

            .pill-tier {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                padding: 0.1rem 0.55rem;
                border-radius: 999px;
                font-size: 0.7rem;
                text-transform: uppercase;
                letter-spacing: 0.06em;
            }

            .pill-tier-common {
                background: #343a40;
                color: #f8f9fa;
            }

            .pill-tier-uncommon {
                background: #495057;
                color: #f8f9fa;
            }

            .pill-tier-rare {
                background: #ff8800;
                color: #111;
            }

            .pill-tier-legendary {
                background: linear-gradient(135deg, #ffd54f, #ffb300);
                color: #111;
            }

            .pill-tier-ultimate {
                background: linear-gradient(135deg, #ff5b81, #ffb64d, #6f42c1, #00d4ff);
                color: #111;
            }

            .expand-icon {
                color: var(--text-muted);
                font-size: 0.7rem;
                display: inline-block;
                width: 16px;
            }

            tr[style*="cursor: pointer"]:hover {
                background: rgba(111, 66, 193, 0.1);
            }

            .edition-moments-row {
                background: rgba(15, 23, 42, 0.3);
            }

            @media (max-width: 960px) {
                header.app-header {
                    flex-direction: column;
                    align-items: flex-start;
                    gap: 0.75rem;
                }

                .wallet-form {
                    width: 100%;
                    justify-content: flex-start;
                }

                main.app-main {
                    padding: 0 1rem;
                }

                .layout-two-column {
                    grid-template-columns: minmax(0, 1fr);
                }
            }
        </style>
    </head>
    <body>
        <link rel="stylesheet" href="/header.css" />
        <div id="app-header"></div>
        <script src="/layout.js"></script>

        <main class="app-main">
            <div class="page-title">Moment explorer</div>
            <div class="page-subtitle">
                Search NFL ALL DAY moments by player, team, tier, series, set and position using your local Neon
                database.
            </div>

            <div class="layout-two-column">
                <!-- LEFT FILTERS -->
                <aside class="filters-card">
                    <div class="filters-title">Filters</div>
                    <div class="filters-help">
                        Pick a player or team from the dropdowns, then refine with tier, series, set, and position.
                    </div>

                    <div class="filter-group">
                        <div class="filter-label">Player</div>
                        <select id="ex-player" class="filter-select">
                            <option value="">All players</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <div class="filter-label">Team</div>
                        <select id="ex-team" class="filter-select">
                            <option value="">All teams</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <div class="filter-label">Tier</div>
                        <select id="ex-tier" class="filter-select">
                            <option value="">All tiers</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <div class="filter-label">Series</div>
                        <select id="ex-series" class="filter-select">
                            <option value="">All series</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <div class="filter-label">Set</div>
                        <select id="ex-set" class="filter-select">
                            <option value="">All sets</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <div class="filter-label">Position</div>
                        <select id="ex-position" class="filter-select">
                            <option value="">All positions</option>
                        </select>
                    </div>

                    <div class="filters-actions">
                        <button id="ex-search-btn" type="button" class="btn-primary">Search</button>
                        <button id="ex-reset-btn" type="button" class="btn-secondary">Reset</button>
                    </div>
                </aside>

                <!-- RIGHT RESULTS -->
                <section class="results-card">
                    <div class="results-header">
                        <div class="results-title">Results</div>
                        <div class="results-subtitle" id="ex-results-summary">
                            Enter filters on the left and hit Search.
                        </div>
                        <div id="ex-pager-info" style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem; display: none;"></div>
                    </div>
                    <div class="results-body">
                        <div id="ex-empty" class="empty-state">No search yet.</div>

                        <div class="table-container">
                            <div style="margin-bottom: 0.75rem; display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; justify-content: space-between;">
                                <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                                    <label style="font-size: 0.85rem; color: var(--text-muted);">Sort by:</label>
                                    <select id="ex-sort" class="filter-select" style="width: auto; min-width: 150px;">
                                        <option value="player">Player (A-Z)</option>
                                        <option value="player-desc">Player (Z-A)</option>
                                        <option value="price-low">Price: Lowest Ask (Low-High)</option>
                                        <option value="price-high">Price: Lowest Ask (High-Low)</option>
                                        <option value="asp-low">Price: Avg Sale (Low-High)</option>
                                        <option value="asp-high">Price: Avg Sale (High-Low)</option>
                                        <option value="tier">Tier</option>
                                        <option value="moments">Moments Count</option>
                                    </select>
                                </div>
                                <button id="ex-export-csv" class="btn-secondary" style="font-size: 0.85rem; padding: 0.4rem 0.8rem;">Export CSV</button>
                            </div>
                            <table class="table" id="ex-table" style="display: none">
                                <thead>
                                    <tr>
                                        <th class="sortable" data-sort="edition_id">Edition ID</th>
                                        <th class="sortable" data-sort="player">Player</th>
                                        <th class="sortable" data-sort="team">Team</th>
                                        <th class="sortable" data-sort="position">Pos</th>
                                        <th class="sortable" data-sort="tier">Tier</th>
                                        <th class="sortable" data-sort="moments">Moments</th>
                                        <th>Serial Range</th>
                                        <th class="sortable" data-sort="max">Max</th>
                                        <th class="sortable" data-sort="price">Lowest Ask</th>
                                        <th class="sortable" data-sort="asp">Avg Sale</th>
                                        <th class="sortable" data-sort="series">Series</th>
                                        <th class="sortable" data-sort="set">Set</th>
                                        <th>Links</th>
                                    </tr>
                                </thead>
                                <tbody id="ex-tbody"></tbody>
                            </table>
                            <div id="ex-pager" style="margin-top: 1rem; display: none; gap: 0.5rem; align-items: center; justify-content: center; flex-wrap: wrap;">
                                <button id="ex-pager-prev" class="btn-secondary" style="font-size: 0.85rem; padding: 0.4rem 0.8rem;">← Previous</button>
                                <button id="ex-pager-next" class="btn-secondary" style="font-size: 0.85rem; padding: 0.4rem 0.8rem;">Next →</button>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </main>

        <script>
            async function loadFilterOptions() {
                const summary = document.getElementById("ex-results-summary");
                try {
                    const res = await fetch("/api/explorer-filters");
                    const data = await res.json();

                    if (!data.ok) {
                        console.error("explorer-filters error:", data.error);
                        summary.textContent = "Filters failed to load: " + (data.error || "unknown error");
                        return;
                    }

                    // Helpers
                    const playerSelect = document.getElementById("ex-player");
                    const teamSelect = document.getElementById("ex-team");
                    const tierSelect = document.getElementById("ex-tier");
                    const seriesSelect = document.getElementById("ex-series");
                    const setSelect = document.getElementById("ex-set");
                    const posSelect = document.getElementById("ex-position");

                    function addOptions(selectEl, items, makeLabel) {
                        items.forEach((item) => {
                            const label = makeLabel ? makeLabel(item) : item;
                            if (!label) return;
                            const opt = document.createElement("option");
                            opt.value = label;
                            opt.textContent = label;
                            selectEl.appendChild(opt);
                        });
                    }

                    // Players
                    playerSelect.innerHTML = '<option value="">All players</option>';
                    addOptions(
                        playerSelect,
                        data.players || [],
                        (p) => [p.first_name, p.last_name].filter(Boolean).join(" ") || null
                    );

                    // Teams
                    teamSelect.innerHTML = '<option value="">All teams</option>';
                    addOptions(teamSelect, data.teams || [], (t) => t);

                    // Tiers – in nice order
                    const tierOrder = ["Common", "Uncommon", "Rare", "Legendary", "Ultimate"];
                    const tiersSet = new Set((data.tiers || []).map((t) => t));
                    tierSelect.innerHTML = '<option value="">All tiers</option>';
                    tierOrder.forEach((t) => {
                        if (tiersSet.has(t) || tiersSet.has(t.toUpperCase())) {
                            const opt = document.createElement("option");
                            opt.value = t;
                            opt.textContent = t;
                            tierSelect.appendChild(opt);
                        }
                    });
                    (data.tiers || []).forEach((t) => {
                        if (!tierOrder.includes(t)) {
                            const opt = document.createElement("option");
                            opt.value = t;
                            opt.textContent = t;
                            tierSelect.appendChild(opt);
                        }
                    });

                    // Series
                    seriesSelect.innerHTML = '<option value="">All series</option>';
                    addOptions(seriesSelect, data.series || [], (s) => s);

                    // Sets
                    setSelect.innerHTML = '<option value="">All sets</option>';
                    addOptions(setSelect, data.sets || [], (s) => s);

                    // Positions
                    posSelect.innerHTML = '<option value="">All positions</option>';
                    addOptions(posSelect, data.positions || [], (p) => p);

                    summary.textContent = "Filters loaded. Pick some and hit Search.";
                } catch (err) {
                    console.error("loadFilterOptions error:", err);
                    summary.textContent = "Filters failed to load – open DevTools Console for details.";
                }
            }

            const PAGE_SIZE = 100;
            let currentEditions = [];
            let currentSortColumn = null;
            let currentSortDirection = "asc"; // "asc" or "desc"
            let currentPage = 1;

            function formatPrice(price) {
                if (price == null) return "—";
                return "$" + Number(price).toLocaleString("en-US", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            }

            function updateSortHeaderClasses() {
                const table = document.getElementById("ex-table");
                if (!table || table.style.display === "none") return;
                
                const headers = table.querySelectorAll("th.sortable");
                headers.forEach((th) => {
                    th.classList.remove("sort-asc", "sort-desc");
                    if (th.dataset.sort === currentSortColumn) {
                        th.classList.add(currentSortDirection === "asc" ? "sort-asc" : "sort-desc");
                    }
                });
            }

            function sortEditions(editions, sortColumn, direction) {
                const sorted = [...editions];
                const isAsc = direction === "asc";
                
                switch (sortColumn) {
                    case "edition_id":
                        sorted.sort((a, b) => {
                            const aVal = (a.edition_id || "").toLowerCase();
                            const bVal = (b.edition_id || "").toLowerCase();
                            return isAsc ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                        });
                        break;
                    case "player":
                        sorted.sort((a, b) => {
                            const aName = ((a.last_name || "") + " " + (a.first_name || "")).trim();
                            const bName = ((b.last_name || "") + " " + (b.first_name || "")).trim();
                            return isAsc ? aName.localeCompare(bName) : bName.localeCompare(aName);
                        });
                        break;
                    case "team":
                        sorted.sort((a, b) => {
                            const aVal = (a.team_name || "").toLowerCase();
                            const bVal = (b.team_name || "").toLowerCase();
                            return isAsc ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                        });
                        break;
                    case "position":
                        sorted.sort((a, b) => {
                            const aVal = (a.position || "").toLowerCase();
                            const bVal = (b.position || "").toLowerCase();
                            return isAsc ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                        });
                        break;
                    case "tier":
                        const tierOrder = { "Common": 1, "Uncommon": 2, "Rare": 3, "Legendary": 4, "Ultimate": 5 };
                        sorted.sort((a, b) => {
                            const aTier = tierOrder[a.tier] || 99;
                            const bTier = tierOrder[b.tier] || 99;
                            return isAsc ? aTier - bTier : bTier - aTier;
                        });
                        break;
                    case "moments":
                        sorted.sort((a, b) => {
                            const aVal = a.total_moments || 0;
                            const bVal = b.total_moments || 0;
                            return isAsc ? aVal - bVal : bVal - aVal;
                        });
                        break;
                    case "max":
                        sorted.sort((a, b) => {
                            const aVal = a.max_mint_size ?? -1;
                            const bVal = b.max_mint_size ?? -1;
                            return isAsc ? aVal - bVal : bVal - aVal;
                        });
                        break;
                    case "price":
                        sorted.sort((a, b) => {
                            const aPrice = a.lowest_ask_usd ?? (isAsc ? Infinity : -1);
                            const bPrice = b.lowest_ask_usd ?? (isAsc ? Infinity : -1);
                            return isAsc ? aPrice - bPrice : bPrice - aPrice;
                        });
                        break;
                    case "asp":
                        sorted.sort((a, b) => {
                            const aPrice = a.avg_sale_usd ?? (isAsc ? Infinity : -1);
                            const bPrice = b.avg_sale_usd ?? (isAsc ? Infinity : -1);
                            return isAsc ? aPrice - bPrice : bPrice - aPrice;
                        });
                        break;
                    case "series":
                        sorted.sort((a, b) => {
                            const aVal = (a.series_name || "").toLowerCase();
                            const bVal = (b.series_name || "").toLowerCase();
                            return isAsc ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                        });
                        break;
                    case "set":
                        sorted.sort((a, b) => {
                            const aVal = (a.set_name || "").toLowerCase();
                            const bVal = (b.set_name || "").toLowerCase();
                            return isAsc ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                        });
                        break;
                    default:
                        // Default to player sort
                        sorted.sort((a, b) => {
                            const aName = ((a.last_name || "") + " " + (a.first_name || "")).trim();
                            const bName = ((b.last_name || "") + " " + (b.first_name || "")).trim();
                            return isAsc ? aName.localeCompare(bName) : bName.localeCompare(aName);
                        });
                }
                return sorted;
            }

            // Legacy function for dropdown compatibility
            function sortEditionsLegacy(editions, sortBy) {
                // Map dropdown values to new sort system
                let column = "player";
                let direction = "asc";
                
                switch (sortBy) {
                    case "player": column = "player"; direction = "asc"; break;
                    case "player-desc": column = "player"; direction = "desc"; break;
                    case "price-low": column = "price"; direction = "asc"; break;
                    case "price-high": column = "price"; direction = "desc"; break;
                    case "asp-low": column = "asp"; direction = "asc"; break;
                    case "asp-high": column = "asp"; direction = "desc"; break;
                    case "tier": column = "tier"; direction = "asc"; break;
                    case "moments": column = "moments"; direction = "desc"; break;
                }
                
                currentSortColumn = column;
                currentSortDirection = direction;
                // Don't update header classes here - will be called after table is rendered
                return sortEditions(editions, column, direction);
            }


            function renderTable(editions, page = 1) {
                const tbody = document.getElementById("ex-tbody");
                const table = document.getElementById("ex-table");
                const empty = document.getElementById("ex-empty");
                const pagerInfo = document.getElementById("ex-pager-info");
                
                tbody.innerHTML = "";

                if (!editions || !editions.length) {
                    empty.style.display = "block";
                    empty.textContent = "No editions matched your filters.";
                    table.style.display = "none";
                    pagerInfo.style.display = "none";
                    return;
                }

                empty.style.display = "none";
                table.style.display = "table";

                // Pagination
                const total = editions.length;
                const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
                currentPage = Math.max(1, Math.min(page, totalPages));
                const start = (currentPage - 1) * PAGE_SIZE;
                const end = Math.min(start + PAGE_SIZE, total);
                const pageEditions = editions.slice(start, end);

                // Update pager info
                if (totalPages > 1) {
                    pagerInfo.style.display = "block";
                    pagerInfo.textContent = `Page ${currentPage} of ${totalPages} • Showing ${start + 1}-${end} of ${total.toLocaleString()} editions`;
                } else {
                    pagerInfo.style.display = "none";
                }

                for (const e of pageEditions) {
                    const tr = document.createElement("tr");
                    const playerName = [e.first_name, e.last_name].filter(Boolean).join(" ");
                    const serialRange = e.min_serial && e.max_serial 
                        ? `${e.min_serial} - ${e.max_serial}` 
                        : e.min_serial 
                            ? `#${e.min_serial}` 
                            : "—";

                    const tier = (e.tier || "").toLowerCase();
                    let tierClass = "";
                    if (tier === "common") tierClass = "pill-tier-common";
                    else if (tier === "uncommon") tierClass = "pill-tier-uncommon";
                    else if (tier === "rare") tierClass = "pill-tier-rare";
                    else if (tier === "legendary") tierClass = "pill-tier-legendary";
                    else if (tier === "ultimate") tierClass = "pill-tier-ultimate";

                    const marketUrl = e.edition_id ? `https://nflallday.com/listing/moment/${e.edition_id}` : "";

                    tr.innerHTML = `
              <td style="font-family: ui-monospace, monospace; font-size: 0.7rem; max-width: 120px; overflow: hidden; text-overflow: ellipsis;" title="${e.edition_id || ""}">${e.edition_id || ""}</td>
              <td style="max-width: 140px; overflow: hidden; text-overflow: ellipsis;" title="${playerName || "(unknown)"}">${playerName || "(unknown)"}</td>
              <td style="max-width: 100px; overflow: hidden; text-overflow: ellipsis;">${e.team_name || ""}</td>
              <td>${e.position || ""}</td>
              <td>
                ${tierClass ? `<span class="pill-tier ${tierClass}">${e.tier || ""}</span>` : e.tier || ""}
              </td>
              <td style="text-align: center;"><strong>${e.total_moments || 0}</strong></td>
              <td style="font-size: 0.7rem; max-width: 90px; overflow: hidden; text-overflow: ellipsis;">${serialRange}</td>
              <td style="text-align: center;">${e.max_mint_size || "—"}</td>
              <td style="font-weight: 500; text-align: right; min-width: 80px;">${formatPrice(e.lowest_ask_usd)}</td>
              <td style="text-align: right; min-width: 80px;">${formatPrice(e.avg_sale_usd)}</td>
              <td style="max-width: 100px; overflow: hidden; text-overflow: ellipsis;">${e.series_name || ""}</td>
              <td style="max-width: 100px; overflow: hidden; text-overflow: ellipsis;">${e.set_name || ""}</td>
              <td>
                ${marketUrl ? `<a href="${marketUrl}" target="_blank">Market</a>` : ""}
              </td>
            `;
                    tbody.appendChild(tr);
                }

                // Update pagination buttons
                const prevBtn = document.getElementById("ex-pager-prev");
                const nextBtn = document.getElementById("ex-pager-next");
                if (prevBtn) {
                    prevBtn.disabled = currentPage <= 1;
                }
                if (nextBtn) {
                    nextBtn.disabled = currentPage >= totalPages;
                }

                // Update sort header classes after table is rendered
                updateSortHeaderClasses();
            }

            async function runSearch() {
                const player = document.getElementById("ex-player").value.trim();
                const team = document.getElementById("ex-team").value.trim();
                const tier = document.getElementById("ex-tier").value.trim();
                const series = document.getElementById("ex-series").value.trim();
                const set = document.getElementById("ex-set").value.trim();
                const position = document.getElementById("ex-position").value.trim();

                const params = new URLSearchParams();
                if (player) params.set("player", player);
                if (team) params.set("team", team);
                if (tier) params.set("tier", tier);
                if (series) params.set("series", series);
                if (set) params.set("set", set);
                if (position) params.set("position", position);
                params.set("limit", "200");

                const summary = document.getElementById("ex-results-summary");
                const empty = document.getElementById("ex-empty");
                const table = document.getElementById("ex-table");
                const tbody = document.getElementById("ex-tbody");

                if (!params.toString()) {
                    summary.textContent = "Choose at least one filter before searching.";
                    table.style.display = "none";
                    empty.style.display = "block";
                    empty.textContent = "No search yet.";
                    return;
                }

                summary.textContent = "Searching…";
                empty.style.display = "block";
                empty.textContent = "Loading…";
                table.style.display = "none";

                try {
                    const res = await fetch("/api/search-editions?" + params.toString());
                    const data = await res.json();
                    
                    if (!res.ok || !data.ok) {
                        const errorMsg = data.error || `HTTP ${res.status}: ${res.statusText}`;
                        console.error("API error:", errorMsg, data);
                        throw new Error(errorMsg);
                    }

                    if (!data.editions) {
                        console.error("Unexpected API response format:", data);
                        throw new Error("Invalid response format from server");
                    }

                    currentEditions = data.editions || [];
                    summary.textContent = "Found " + currentEditions.length.toLocaleString() + " edition(s).";
                    
                    // Show/hide pagination
                    const pager = document.getElementById("ex-pager");
                    if (pager) {
                        pager.style.display = currentEditions.length > PAGE_SIZE ? "flex" : "none";
                    }
                    
                    // Apply sorting
                    const sortBy = document.getElementById("ex-sort").value;
                    let sorted = sortEditionsLegacy(currentEditions, sortBy);
                    renderTable(sorted, 1);
                } catch (err) {
                    console.error("runSearch error:", err);
                    console.error("Error details:", {
                        message: err.message,
                        stack: err.stack,
                        name: err.name
                    });
                    summary.textContent = "Search failed: " + (err.message || "Unknown error");
                    empty.style.display = "block";
                    empty.textContent = "Something went wrong. Check console for details.";
                    table.style.display = "none";
                }
            }

            function resetFilters() {
                document.getElementById("ex-player").value = "";
                document.getElementById("ex-team").value = "";
                document.getElementById("ex-tier").value = "";
                document.getElementById("ex-series").value = "";
                document.getElementById("ex-set").value = "";
                document.getElementById("ex-position").value = "";
                document.getElementById("ex-sort").value = "player";

                document.getElementById("ex-results-summary").textContent = "Enter filters on the left and hit Search.";
                document.getElementById("ex-empty").style.display = "block";
                document.getElementById("ex-empty").textContent = "No search yet.";
                document.getElementById("ex-table").style.display = "none";
                document.getElementById("ex-tbody").innerHTML = "";
                currentEditions = [];
            }

            // Wire up buttons and load filter options
            document.getElementById("ex-search-btn").addEventListener("click", runSearch);
            document.getElementById("ex-reset-btn").addEventListener("click", resetFilters);
            
            // Wire up sort dropdown
            document.getElementById("ex-sort").addEventListener("change", () => {
                if (currentEditions.length) {
                    const sortBy = document.getElementById("ex-sort").value;
                    let sorted = sortEditionsLegacy(currentEditions, sortBy);
                    renderTable(sorted, 1); // Reset to page 1 when sorting changes
                }
            });

            // Wire up pagination buttons
            const prevBtn = document.getElementById("ex-pager-prev");
            const nextBtn = document.getElementById("ex-pager-next");
            if (prevBtn) {
                prevBtn.addEventListener("click", () => {
                    if (currentEditions.length) {
                        const sortBy = document.getElementById("ex-sort").value;
                        let sorted = sortEditionsLegacy(currentEditions, sortBy);
                        renderTable(sorted, currentPage - 1);
                    }
                });
            }
            if (nextBtn) {
                nextBtn.addEventListener("click", () => {
                    if (currentEditions.length) {
                        const sortBy = document.getElementById("ex-sort").value;
                        let sorted = sortEditionsLegacy(currentEditions, sortBy);
                        renderTable(sorted, currentPage + 1);
                    }
                });
            }

            // Wire up CSV export
            document.getElementById("ex-export-csv").addEventListener("click", () => {
                if (!currentEditions.length) return;

                const sortBy = document.getElementById("ex-sort").value;
                const sorted = sortEditionsLegacy(currentEditions, sortBy);

                const headers = [
                    "edition_id",
                    "first_name",
                    "last_name",
                    "team_name",
                    "position",
                    "tier",
                    "total_moments",
                    "min_serial",
                    "max_serial",
                    "max_mint_size",
                    "lowest_ask_usd",
                    "avg_sale_usd",
                    "top_sale_usd",
                    "series_name",
                    "set_name"
                ];

                const lines = [];
                lines.push(headers.join(","));

                for (const e of sorted) {
                    const line = headers
                        .map((h) => {
                            let v = e[h];
                            if (v == null) v = "";
                            const s = String(v).replace(/"/g, '""');
                            if (s.search(/[",\n]/) >= 0) {
                                return `"${s}"`;
                            }
                            return s;
                        })
                        .join(",");
                    lines.push(line);
                }

                const csv = lines.join("\n");
                const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
                const url = URL.createObjectURL(blob);

                const a = document.createElement("a");
                a.href = url;
                a.download = `editions-${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });

            // Wire up column header clicks
            document.addEventListener("DOMContentLoaded", () => {
                const table = document.getElementById("ex-table");
                if (table) {
                    const headers = table.querySelectorAll("th.sortable");
                    headers.forEach((th) => {
                        th.addEventListener("click", () => {
                            const sortColumn = th.dataset.sort;
                            if (!sortColumn) return;

                            // Toggle direction if clicking the same column
                            if (currentSortColumn === sortColumn) {
                                currentSortDirection = currentSortDirection === "asc" ? "desc" : "asc";
                            } else {
                                currentSortColumn = sortColumn;
                                currentSortDirection = "asc";
                            }

                            updateSortHeaderClasses();
                            
                            if (currentEditions.length) {
                                const sorted = sortEditions(currentEditions, currentSortColumn, currentSortDirection);
                                renderTable(sorted, 1); // Reset to page 1 when sorting changes
                            }
                        });
                    });
                }
            });

            loadFilterOptions();
        </script>
        <script>
  (function () {
    async function updateNavAccount() {
      const link = document.getElementById("nav-account-link");
      if (!link) return;

      try {
        const res = await fetch("/api/me");
        const data = await res.json();

        if (data && data.user) {
          // Logged in: show email and point to login/account page
          link.href = "/login.html";
          link.textContent = data.user.email;
        } else {
          // Not logged in
          link.href = "/login.html";
          link.textContent = "Login";
        }
      } catch (err) {
        console.error("updateNavAccount error:", err);
      }
    }

    updateNavAccount();
  })();
</script>

    </body>
</html>
