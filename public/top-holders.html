<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Top holders ‚Äì Chunky's NFLAD Viewer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/styles.css" />
    <link rel="stylesheet" href="/header.css" />
    <style>
      :root {
        --bg: #050815;
        --bg-elevated: #0b1020;
        --bg-elevated-soft: #101526;
        --border-soft: #1b2236;
        --text: #f8f9ff;
        --text-muted: #8c95b8;
        --accent: #6f42c1;
        --accent2: #007bff;
        --accent-soft: rgba(111, 66, 193, 0.18);
        --radius-lg: 16px;
        --radius-md: 12px;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 0;
        font-family:
          system-ui,
          -apple-system,
          BlinkMacSystemFont,
          "Segoe UI",
          sans-serif;
        background: radial-gradient(circle at top, #101526 0, #050815 55%);
        color: var(--text);
      }

      a {
        color: var(--accent2);
        text-decoration: none;
      }

      a:hover {
        text-decoration: underline;
      }

      /* Header styles are in /header.css */

      .btn-secondary {
        border-radius: 999px;
        border: 1px solid var(--border-soft);
        padding: 0.4rem 0.9rem;
        background: transparent;
        color: var(--text-muted);
        font-size: 0.8rem;
        cursor: pointer;
      }

      .btn-secondary:hover {
        border-color: var(--accent);
        color: var(--accent2);
      }

      /* Layout */

      main.app-main {
        max-width: 1320px;
        margin: 1.5rem auto 2.5rem;
        padding: 0 1.5rem;
      }

      .page-title {
        font-size: 1.15rem;
        font-weight: 600;
        margin-bottom: 0.25rem;
      }

      .page-subtitle {
        font-size: 0.85rem;
        color: var(--text-muted);
        margin-bottom: 1.25rem;
      }

      .top-card {
        background: #050915;
        border-radius: var(--radius-lg);
        border: 1px solid var(--border-soft);
        overflow: hidden;
      }

      .top-header {
        padding: 0.9rem 1.3rem;
        border-bottom: 1px solid var(--border-soft);
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
      }

      .top-header-left {
        min-width: 0;
      }

      .top-header-title {
        font-size: 0.95rem;
        font-weight: 600;
      }

      .top-header-subtitle {
        font-size: 0.8rem;
        color: var(--text-muted);
      }

      .top-header-controls {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 0.78rem;
      }

      .top-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--text-muted);
      }

      .top-select {
        background: #050a18;
        border-radius: 999px;
        border: 1px solid var(--border-soft);
        padding: 0.28rem 0.75rem;
        color: var(--text);
        font-size: 0.78rem;
        outline: none;
      }

      .top-body {
        padding: 0.9rem 1.3rem 1.2rem;
      }

      .top-status {
        font-size: 0.8rem;
        color: var(--text-muted);
        margin-bottom: 0.5rem;
      }

      .table-container {
        max-height: 70vh;
        overflow: auto;
        border-radius: var(--radius-md);
        border: 1px solid var(--border-soft);
        background: #050815;
      }

      table.table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.78rem;
      }

      table.table th,
      table.table td {
        padding: 0.4rem 0.6rem;
        white-space: nowrap;
      }

      table.table thead {
        position: sticky;
        top: 0;
        background: #0b1020;
        z-index: 1;
      }

      table.table th {
        text-align: left;
        font-weight: 500;
        color: var(--text-muted);
        border-bottom: 1px solid var(--border-soft);
      }

      table.table tbody tr:nth-child(even) {
        background: rgba(255, 255, 255, 0.01);
      }

      table.table td {
        border-bottom: 1px solid rgba(255, 255, 255, 0.01);
      }

      .addr {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        font-size: 0.72rem;
        color: var(--text-muted);
      }

      .pill-unlocked {
        color: #4ade80;
      }

      .pill-locked {
        color: #fbbf24;
      }

      .pill-tier-common {
        color: #e5e7eb;
      }

      .pill-tier-uncommon {
        color: #cbd5f5;
      }

      .pill-tier-rare {
        color: #fb923c;
      }

      .pill-tier-legendary {
        color: #facc15;
      }

      .pill-tier-ultimate {
        color: #f472b6;
      }

      .btn-link {
        font-size: 0.75rem;
      }

      @media (max-width: 960px) {
        main.app-main {
          padding: 0 1rem;
        }

        .top-header {
          flex-direction: column;
          align-items: flex-start;
        }

        .top-header-controls {
          width: 100%;
          justify-content: flex-start;
          flex-wrap: wrap;
        }
      }
    </style>
  </head>
  <body>
    <link rel="stylesheet" href="/header.css" />
    <div id="app-header"></div>
    <script src="/layout.js"></script>

    <main class="app-main">
      <div class="page-title">üèÜ Leaderboard</div>

      <section class="top-card">
        <div class="top-header">
          <div class="top-header-left">
            <div class="top-header-title">Top Collectors</div>
            <div class="top-header-subtitle" id="top-subtitle"></div>
          </div>
          <div class="top-header-controls">
            <div>
              <div class="top-label">View</div>
              <select id="top-view" class="top-select">
                <option value="total">By Total Moments</option>
                <option value="value">By Collection Value</option>
                <option value="team">By Team</option>
                <option value="tier">By Tier</option>
                <option value="moment">By Moment/Edition</option>
              </select>
            </div>
            <div id="view-filter-container" style="display: none;">
              <div class="top-label" id="view-filter-label">Filter</div>
              <select id="view-filter-select" class="top-select" style="display: none;"></select>
              <input id="view-filter-input" class="top-select" type="text" placeholder="Enter edition ID..." style="display: none;" />
            </div>
            <div>
              <div class="top-label">Show</div>
              <select id="top-limit" class="top-select">
                <option value="25">Top 25</option>
                <option value="50" selected>Top 50</option>
                <option value="100">Top 100</option>
                <option value="250">Top 250</option>
                <option value="500">Top 500</option>
              </select>
            </div>
            <button id="top-refresh" type="button" class="btn-secondary">Refresh</button>
          </div>
        </div>

        <div class="top-body">
          <div id="top-status" class="top-status">Loading leaderboard‚Ä¶</div>

          <div class="table-container">
            <table class="table" id="top-table" style="display: none">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Display name</th>
                  <th>Wallet</th>
                  <th>Total</th>
                  <th>Unlocked</th>
                  <th>Locked</th>
                  <th>Common</th>
                  <th>Uncommon</th>
                  <th>Rare</th>
                  <th>Legendary</th>
                  <th>Ultimate</th>
                  <th id="value-header" style="display: none;">Floor Value</th>
                  <th>Wallet viewer</th>
                </tr>
              </thead>
              <tbody id="top-tbody"></tbody>
            </table>
          </div>

          <!-- Mobile Card View -->
          <div class="mobile-cards" id="top-mobile-cards"></div>
        </div>
      </section>
    </main>

    <script>
      (function () {
        const viewSelect = document.getElementById("top-view");
        const viewFilterContainer = document.getElementById("view-filter-container");
        const viewFilterSelect = document.getElementById("view-filter-select");
        const viewFilterInput = document.getElementById("view-filter-input");
        const viewFilterLabel = document.getElementById("view-filter-label");
        const limitSelect = document.getElementById("top-limit");
        const refreshBtn = document.getElementById("top-refresh");
        const statusEl = document.getElementById("top-status");
        const subtitleEl = document.getElementById("top-subtitle");
        const tableEl = document.getElementById("top-table");
        const tbodyEl = document.getElementById("top-tbody");
        const valueHeader = document.getElementById("value-header");

        let teamsList = [];
        let editionsList = [];

        function formatNumber(n) {
          if (n == null) return "0";
          return Number(n).toLocaleString();
        }

        function formatCurrency(n) {
          if (n == null || n === 0) return "$0.00";
          return "$" + Number(n).toLocaleString(undefined, {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
          });
        }

        function shortAddr(addr) {
          if (!addr || addr.length <= 12) return addr || "";
          return addr.slice(0, 6) + "‚Ä¶" + addr.slice(-4);
        }

        async function loadTeams() {
          try {
            const res = await fetch("/api/teams");
            
            // Check if response is JSON
            const contentType = res.headers.get("content-type");
            if (!contentType || !contentType.includes("application/json")) {
              const text = await res.text();
              console.error("Teams endpoint returned non-JSON:", text.substring(0, 200));
              return;
            }
            
            const data = await res.json();
            if (data.ok && Array.isArray(data.teams)) {
              teamsList = data.teams;
              if (viewFilterSelect) {
                viewFilterSelect.innerHTML = '<option value="">Select team...</option>' +
                  teamsList.map(t => `<option value="${t}">${t}</option>`).join('');
              }
              console.log("Loaded", teamsList.length, "teams");
            } else {
              console.error("Teams endpoint returned invalid data:", data);
            }
          } catch (err) {
            console.error("Failed to load teams:", err);
          }
        }

        function updateViewControls() {
          const view = viewSelect.value;
          viewFilterContainer.style.display = "none";
          viewFilterSelect.style.display = "none";
          viewFilterInput.style.display = "none";
          valueHeader.style.display = "none";

          if (view === "team") {
            viewFilterContainer.style.display = "block";
            viewFilterSelect.style.display = "block";
            viewFilterLabel.textContent = "Team";
            subtitleEl.textContent = "Ranked by total moments from selected team.";
            // Load teams if not already loaded
            if (teamsList.length === 0) {
              loadTeams();
            } else {
              // Update dropdown with existing teams
              viewFilterSelect.innerHTML = '<option value="">Select team...</option>' +
                teamsList.map(t => `<option value="${t}">${t}</option>`).join('');
            }
          } else if (view === "tier") {
            viewFilterContainer.style.display = "block";
            viewFilterSelect.style.display = "block";
            viewFilterLabel.textContent = "Tier";
            viewFilterSelect.innerHTML = `
              <option value="">Select tier...</option>
              <option value="Common">Common</option>
              <option value="Uncommon">Uncommon</option>
              <option value="Rare">Rare</option>
              <option value="Legendary">Legendary</option>
              <option value="Ultimate">Ultimate</option>
            `;
            subtitleEl.textContent = "Ranked by total moments of selected tier.";
          } else if (view === "value") {
            subtitleEl.textContent = "Ranked by collection floor value (sum of lowest asks).";
            valueHeader.style.display = "table-cell";
          } else if (view === "moment") {
            viewFilterContainer.style.display = "block";
            viewFilterInput.style.display = "block";
            viewFilterLabel.textContent = "Edition ID";
            subtitleEl.textContent = "Ranked by copies owned of selected edition.";
          } else {
            subtitleEl.textContent = "Ranked by total moments, including locked and unlocked counts and tier breakdowns.";
          }
        }

        async function loadTopWallets() {
          const view = viewSelect.value;
          const limit = limitSelect.value || "50";
          const filter = viewFilterSelect.style.display !== "none" ? viewFilterSelect.value : 
                        (viewFilterInput.style.display !== "none" ? viewFilterInput.value : "");

          statusEl.textContent = "Loading‚Ä¶";
          tableEl.style.display = "none";
          tbodyEl.innerHTML = "";

          try {
            let url = "";
            if (view === "total") {
              url = "/api/top-wallets?limit=" + encodeURIComponent(limit);
            } else if (view === "value") {
              url = "/api/top-wallets-by-value?limit=" + encodeURIComponent(limit) + "&valueType=floor";
            } else if (view === "team") {
              if (!filter) {
                statusEl.textContent = "Please select a team.";
                return;
              }
              url = "/api/top-wallets-by-team?limit=" + encodeURIComponent(limit) + "&team=" + encodeURIComponent(filter);
            } else if (view === "tier") {
              if (!filter) {
                statusEl.textContent = "Please select a tier.";
                return;
              }
              url = "/api/top-wallets-by-tier?limit=" + encodeURIComponent(limit) + "&tier=" + encodeURIComponent(filter);
            } else if (view === "moment") {
              if (!filter) {
                statusEl.textContent = "Please enter an edition ID.";
                return;
              }
              url = "/api/top-holders?edition=" + encodeURIComponent(filter);
            }

            if (!url) {
              statusEl.textContent = "Invalid view selection.";
              return;
            }

            const res = await fetch(url);
            
            // Check if response is JSON
            const contentType = res.headers.get("content-type");
            if (!contentType || !contentType.includes("application/json")) {
              const text = await res.text();
              console.error("Non-JSON response:", text.substring(0, 200));
              throw new Error("Server returned non-JSON response. Status: " + res.status);
            }
            
            const data = await res.json();

            if (!res.ok || !data.ok) {
              throw new Error(data.error || "Failed to load leaderboard");
            }

            const wallets = Array.isArray(data.wallets || data.rows) ? (data.wallets || data.rows) : [];

            if (!wallets.length) {
              statusEl.textContent = "No wallets found.";
              return;
            }

            let statusText = "Showing top " + wallets.length + " wallet(s)";
            if (view === "team") statusText += " for team: " + filter;
            else if (view === "tier") statusText += " for tier: " + filter;
            else if (view === "moment") statusText += " for edition: " + filter;
            else if (view === "value") statusText += " by collection value";
            else statusText += " by total moments";
            statusEl.textContent = statusText + ".";

            // Mobile cards container
            const mobileCards = document.getElementById("top-mobile-cards");
            if (mobileCards) mobileCards.innerHTML = "";

            wallets.forEach((w, idx) => {
              const tr = document.createElement("tr");

              const displayName = w.display_name || w.wallet_address || "(unknown)";
              const addr = w.wallet_address || "";

              const total = w.total_moments || w.copies || 0;
              const unlocked = Number(w.unlocked_moments || w.unlocked_count || 0);
              const locked = Number(w.locked_moments || w.locked_count || 0);
              const tierCommon = Number(w.tier_common || 0);
              const tierUncommon = Number(w.tier_uncommon || 0);
              const tierRare = Number(w.tier_rare || 0);
              const tierLegendary = Number(w.tier_legendary || 0);
              const tierUltimate = Number(w.tier_ultimate || 0);
              const floorValue = Number(w.floor_value || 0);

              let rowHtml = 
                "<td>" + (idx + 1) + "</td>" +
                "<td>" + displayName + "</td>" +
                '<td class="addr">' + shortAddr(addr) + "</td>" +
                "<td>" + formatNumber(total) + "</td>" +
                '<td class="pill-unlocked">' + formatNumber(unlocked) + "</td>" +
                '<td class="pill-locked">' + formatNumber(locked) + "</td>" +
                '<td class="pill-tier-common">' + formatNumber(tierCommon) + "</td>" +
                '<td class="pill-tier-uncommon">' + formatNumber(tierUncommon) + "</td>" +
                '<td class="pill-tier-rare">' + formatNumber(tierRare) + "</td>" +
                '<td class="pill-tier-legendary">' + formatNumber(tierLegendary) + "</td>" +
                '<td class="pill-tier-ultimate">' + formatNumber(tierUltimate) + "</td>";

              // Add value column when viewing by value (must match header position)
              if (view === "value") {
                rowHtml += '<td style="font-weight: 600; color: var(--accent2);">' + formatCurrency(floorValue) + "</td>";
              }

              rowHtml += '<td><a class="btn-link" href="/?wallet=' + encodeURIComponent(addr) + '">View</a></td>';

              tr.innerHTML = rowHtml;
              tbodyEl.appendChild(tr);

              // Mobile card
              if (mobileCards) {
                const rank = idx + 1;
                const isTop3 = rank <= 3;
                const card = document.createElement("a");
                card.href = "/?wallet=" + encodeURIComponent(addr);
                card.className = "mobile-card";
                card.innerHTML = `
                  <div class="mobile-card-rank ${isTop3 ? 'top3' : ''}">${rank}</div>
                  <div class="mobile-card-main">
                    <div class="mobile-card-header">
                      <span class="mobile-card-title">${displayName}</span>
                    </div>
                    <div class="mobile-card-details">
                      <span>${shortAddr(addr)}</span>
                      <span style="color: #4ade80;">‚úì${formatNumber(unlocked)}</span>
                      <span style="color: #fbbf24;">üîí${formatNumber(locked)}</span>
                    </div>
                  </div>
                  <div class="mobile-card-right">
                    <div class="mobile-card-value">${formatNumber(total)}</div>
                    <div class="mobile-card-sub">${view === "value" ? formatCurrency(floorValue) : "moments"}</div>
                  </div>
                `;
                mobileCards.appendChild(card);
              }
            });

            tableEl.style.display = "table";
          } catch (err) {
            console.error("top-wallets error:", err);
            let errorMsg = "Failed to load leaderboard.";
            if (err.message) {
              errorMsg += " " + err.message;
            } else if (typeof err === 'string') {
              errorMsg += " " + err;
            }
            statusEl.textContent = errorMsg + " Check console for details.";
            tableEl.style.display = "none";
          }
        }

        viewSelect.addEventListener("change", () => {
          updateViewControls();
          if (viewFilterSelect) viewFilterSelect.value = "";
          if (viewFilterInput) viewFilterInput.value = "";
          loadTopWallets();
        });

        if (viewFilterSelect) {
          viewFilterSelect.addEventListener("change", loadTopWallets);
        }

        if (viewFilterInput) {
          let inputTimeout;
          viewFilterInput.addEventListener("input", () => {
            clearTimeout(inputTimeout);
            inputTimeout = setTimeout(loadTopWallets, 500);
          });
        }

        limitSelect.addEventListener("change", loadTopWallets);
        refreshBtn.addEventListener("click", loadTopWallets);

        // Initial setup
        updateViewControls();
        // Load teams in background
        loadTeams().then(() => {
          console.log("Teams loaded successfully");
        }).catch(err => {
          console.error("Error loading teams:", err);
        });
        loadTopWallets();
      })();
    </script>
    <script>
  (function () {
    async function updateNavAccount() {
      const link = document.getElementById("nav-account-link");
      if (!link) return;

      try {
        const res = await fetch("/api/me");
        const data = await res.json();

        if (data && data.user) {
          // Logged in: show email and point to login/account page
          link.href = "/login.html";
          link.textContent = data.user.email;
        } else {
          // Not logged in
          link.href = "/login.html";
          link.textContent = "Login";
        }
      } catch (err) {
        console.error("updateNavAccount error:", err);
      }
    }

    updateNavAccount();
  })();
</script>

  </body>
</html>
