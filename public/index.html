<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>NFL ALL DAY Wallet Viewer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        color-scheme: dark;
        --bg: #05060a;
        --bg-alt: #0b0d14;
        --panel: #111522;
        --panel-alt: #181d2c;
        --accent: #3b82f6;
        --accent-soft: rgba(59, 130, 246, 0.14);
        --text: #e5e7eb;
        --text-muted: #9ca3af;
        --border: #1f2937;
        --danger: #ef4444;
        --success: #22c55e;
        --locked: #f97316;
        --locked-soft: rgba(249, 115, 22, 0.16);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family:
          system-ui,
          -apple-system,
          BlinkMacSystemFont,
          "Segoe UI",
          sans-serif;
        background: radial-gradient(circle at top, #020617 0, #020617 30%, #020617 60%, #020617 100%);
        color: var(--text);
      }

      a {
        color: var(--accent);
        text-decoration: none;
      }

      a:hover {
        text-decoration: underline;
      }

      .app {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      header {
        padding: 12px 20px;
        border-bottom: 1px solid var(--border);
        background: linear-gradient(to right, #020617, #020617 40%, #020617 100%);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }

      .logo {
        font-weight: 700;
        font-size: 18px;
        letter-spacing: 0.06em;
        text-transform: uppercase;
        color: #f9fafb;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .logo-pill {
        width: 26px;
        height: 26px;
        border-radius: 999px;
        border: 2px solid var(--accent);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        color: var(--accent);
      }

      .header-right {
        font-size: 12px;
        color: var(--text-muted);
      }

      main.layout {
        flex: 1;
        display: grid;
        grid-template-columns: 260px minmax(0, 1fr);
        gap: 0;
        min-height: 0;
      }

      @media (max-width: 900px) {
        main.layout {
          grid-template-columns: 1fr;
        }
        aside.sidebar {
          border-right: none;
          border-bottom: 1px solid var(--border);
        }
      }

      aside.sidebar {
        background: var(--bg-alt);
        border-right: 1px solid var(--border);
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .sidebar h2 {
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--text-muted);
        margin: 0 0 4px 0;
      }

      .filter-group {
        margin-bottom: 10px;
      }

      .filter-group label {
        display: block;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--text-muted);
        margin-bottom: 4px;
      }

      .filter-group select {
        width: 100%;
        padding: 6px 8px;
        border-radius: 6px;
        border: 1px solid var(--border);
        background: var(--panel-alt);
        color: var(--text);
        font-size: 13px;
      }

      .filter-group select:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 1px var(--accent-soft);
      }

      .filters-reset {
        margin-top: 4px;
        font-size: 11px;
        color: var(--accent);
        cursor: pointer;
        border: none;
        background: transparent;
        padding: 0;
        text-align: left;
      }

      section.content {
        padding: 16px 16px 20px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        min-width: 0;
      }

      .wallet-form-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
      }

      .wallet-input {
        flex: 1 1 220px;
        max-width: 420px;
        padding: 7px 10px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: var(--panel-alt);
        color: var(--text);
        font-size: 13px;
      }

      .wallet-input::placeholder {
        color: var(--text-muted);
      }

      .wallet-input:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 1px var(--accent-soft);
      }

      .btn {
        border-radius: 999px;
        border: none;
        padding: 7px 14px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .btn-primary {
        background: var(--accent);
        color: #f9fafb;
      }

      .btn-primary:hover {
        background: #2563eb;
      }

      .status-bar {
        font-size: 12px;
        color: var(--text-muted);
        min-height: 16px;
      }

      .status-bar.error {
        color: var(--danger);
      }

      .card-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 8px;
      }

      .card {
        background: var(--panel);
        border-radius: 10px;
        padding: 8px 10px;
        border: 1px solid var(--border);
        font-size: 12px;
      }

      .card-title {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--text-muted);
        margin-bottom: 2px;
      }

      .card-value {
        font-size: 13px;
        font-weight: 500;
      }

      .wallet-header {
        font-size: 14px;
        font-weight: 500;
      }

      .wallet-header span.address {
        color: var(--text-muted);
        font-size: 12px;
      }

      .table-container {
        margin-top: 8px;
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid var(--border);
        background: var(--panel);
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
      }

      thead {
        background: #020617;
      }

      th,
      td {
        padding: 6px 8px;
        border-bottom: 1px solid #111827;
        white-space: nowrap;
      }

      th {
        text-align: left;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--text-muted);
        cursor: pointer;
        user-select: none;
      }

      th.sortable:hover {
        background: rgba(15, 23, 42, 0.9);
      }

      th .sort-indicator {
        font-size: 10px;
        opacity: 0.6;
        margin-left: 4px;
      }

      tbody tr:nth-child(even) {
        background: var(--panel-alt);
      }

      tbody tr:hover {
        background: #020617;
      }

      .player-cell {
        display: flex;
        flex-direction: column;
      }

      .player-name {
        font-weight: 500;
        font-size: 12px;
      }

      .player-meta {
        font-size: 11px;
        color: var(--text-muted);
      }

      .badge {
        display: inline-flex;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 11px;
        font-weight: 500;
        align-items: center;
        justify-content: center;
      }

      .badge-tier {
        background: rgba(37, 99, 235, 0.15);
        color: #bfdbfe;
        border: 1px solid rgba(37, 99, 235, 0.5);
      }

      .badge-locked {
        background: var(--locked-soft);
        color: #fed7aa;
        border: 1px solid rgba(249, 115, 22, 0.7);
      }

      .badge-unlocked {
        background: rgba(34, 197, 94, 0.12);
        color: #bbf7d0;
        border: 1px solid rgba(34, 197, 94, 0.7);
      }

      .num {
        text-align: right;
        font-variant-numeric: tabular-nums;
      }

      .link-cell a {
        font-size: 11px;
      }

      .empty-state {
        padding: 12px;
        font-size: 13px;
        color: var(--text-muted);
      }
    </style>
  </head>
  <body>
    <div class="app">
      <header>
        <div class="logo">
          <span class="logo-pill">AD</span>
          ALL DAY Wallet Viewer
        </div>
        <div class="header-right">Neon-backed • Snowflake ETL • Dapper names</div>
      </header>

      <main class="layout">
        <aside class="sidebar">
          <div>
            <h2>Filters</h2>
            <div class="filter-group">
              <label for="filterTeam">Team</label>
              <select id="filterTeam">
                <option value="">All teams</option>
              </select>
            </div>
            <div class="filter-group">
              <label for="filterPlayer">Player</label>
              <select id="filterPlayer">
                <option value="">All players</option>
              </select>
            </div>
            <div class="filter-group">
              <label for="filterSeries">Series</label>
              <select id="filterSeries">
                <option value="">All series</option>
              </select>
            </div>
            <div class="filter-group">
              <label for="filterSet">Set</label>
              <select id="filterSet">
                <option value="">All sets</option>
              </select>
            </div>
            <div class="filter-group">
              <label for="filterTier">Tier</label>
              <select id="filterTier">
                <option value="">All tiers</option>
              </select>
            </div>
            <div class="filter-group">
              <label for="filterPosition">Position</label>
              <select id="filterPosition">
                <option value="">All positions</option>
              </select>
            </div>
            <div class="filter-group">
              <label for="filterLocked">Locked status</label>
              <select id="filterLocked">
                <option value="">Locked + Unlocked</option>
                <option value="locked">Locked only</option>
                <option value="unlocked">Unlocked only</option>
              </select>
            </div>
            <button type="button" class="filters-reset" id="resetFilters">Reset filters</button>
          </div>
        </aside>

        <section class="content">
          <form id="walletForm">
            <div class="wallet-form-row">
              <input
                id="walletInput"
                class="wallet-input"
                type="text"
                placeholder="Paste Dapper wallet address (0x...)"
                autocomplete="off" />
              <button class="btn btn-primary" type="submit">Load wallet</button>
            </div>
          </form>

          <div id="status" class="status-bar"></div>
          <div id="walletHeader" class="wallet-header"></div>

          <div class="card-row" id="summaryRow" style="display: none">
            <div class="card">
              <div class="card-title">Total Moments</div>
              <div class="card-value" id="summaryTotal">0</div>
            </div>
            <div class="card">
              <div class="card-title">Unlocked</div>
              <div class="card-value" id="summaryUnlocked">0</div>
            </div>
            <div class="card">
              <div class="card-title">Locked</div>
              <div class="card-value" id="summaryLocked">0</div>
            </div>
            <div class="card">
              <div class="card-title">Sum Low Ask</div>
              <div class="card-value" id="summaryLowAsk">$0.00</div>
            </div>
            <div class="card">
              <div class="card-title">Sum ASP (90d)</div>
              <div class="card-value" id="summaryAsp">$0.00</div>
            </div>
          </div>

          <div class="table-container" id="tableContainer" style="display: none">
            <table>
              <thead>
                <tr>
                  <th class="sortable" data-sort-key="player">Player<span class="sort-indicator"></span></th>
                  <th class="sortable" data-sort-key="team">Team<span class="sort-indicator"></span></th>
                  <th class="sortable" data-sort-key="position">Pos<span class="sort-indicator"></span></th>
                  <th class="sortable" data-sort-key="tier">Tier<span class="sort-indicator"></span></th>
                  <th class="sortable" data-sort-key="series">Series<span class="sort-indicator"></span></th>
                  <th class="sortable" data-sort-key="set">Set<span class="sort-indicator"></span></th>
                  <th class="sortable" data-sort-key="serial">Serial<span class="sort-indicator"></span></th>
                  <th class="sortable num" data-sort-key="lowAsk">Low Ask<span class="sort-indicator"></span></th>
                  <th class="sortable num" data-sort-key="asp">ASP 90d<span class="sort-indicator"></span></th>
                  <th class="sortable" data-sort-key="locked">Locked?<span class="sort-indicator"></span></th>
                  <th class="sortable" data-sort-key="date">Last Event<span class="sort-indicator"></span></th>
                  <th>Links</th>
                </tr>
              </thead>
              <tbody id="resultsBody"></tbody>
            </table>
          </div>

          <div id="emptyState" class="empty-state" style="display: none">No moments found for this wallet.</div>
        </section>
      </main>
    </div>

    <script>
      const walletForm = document.getElementById("walletForm");
      const walletInput = document.getElementById("walletInput");
      const statusEl = document.getElementById("status");
      const walletHeaderEl = document.getElementById("walletHeader");
      const summaryRowEl = document.getElementById("summaryRow");
      const summaryTotalEl = document.getElementById("summaryTotal");
      const summaryUnlockedEl = document.getElementById("summaryUnlocked");
      const summaryLockedEl = document.getElementById("summaryLocked");
      const summaryLowAskEl = document.getElementById("summaryLowAsk");
      const summaryAspEl = document.getElementById("summaryAsp");
      const tableContainerEl = document.getElementById("tableContainer");
      const resultsBody = document.getElementById("resultsBody");
      const emptyStateEl = document.getElementById("emptyState");

      const filterTeam = document.getElementById("filterTeam");
      const filterPlayer = document.getElementById("filterPlayer");
      const filterSeries = document.getElementById("filterSeries");
      const filterSet = document.getElementById("filterSet");
      const filterTier = document.getElementById("filterTier");
      const filterPosition = document.getElementById("filterPosition");
      const filterLocked = document.getElementById("filterLocked");
      const resetFiltersBtn = document.getElementById("resetFilters");

      let allRows = [];
      let currentFilteredRows = [];
      let currentWallet = null;
      let currentSort = { key: "date", dir: "desc" };

      function setStatus(msg, isError = false) {
        statusEl.textContent = msg || "";
        statusEl.classList.toggle("error", !!isError);
      }

      function formatCurrency(n) {
        if (n == null || isNaN(n)) return "";
        return "$" + Number(n).toFixed(2);
      }

      function formatDate(ts) {
        if (!ts) return "";
        const d = new Date(ts);
        if (isNaN(d.getTime())) return "";
        return d.toLocaleDateString() + " " + d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
      }

      async function fetchProfile(wallet) {
        try {
          const res = await fetch(`/api/wallet-profile?wallet=${encodeURIComponent(wallet)}`);
          if (!res.ok) return null;
          const data = await res.json();
          if (!data.ok) return null;
          return data.profile || null;
        } catch {
          return null;
        }
      }

      async function fetchPrices(editionIds) {
        if (!editionIds.length) {
          return { asp: {}, lowAsk: {} };
        }
        const uniq = [...new Set(editionIds)];
        const qs = encodeURIComponent(uniq.join(","));
        const res = await fetch(`/api/prices?editions=${qs}`);
        if (!res.ok) {
          return { asp: {}, lowAsk: {} };
        }
        const data = await res.json();
        if (!data.ok) {
          return { asp: {}, lowAsk: {} };
        }
        return {
          asp: data.asp || {},
          lowAsk: data.lowAsk || {}
        };
      }

      function fillSelect(selectEl, values, placeholder) {
        const sorted = Array.from(values)
          .filter(Boolean)
          .sort((a, b) => a.localeCompare(b));
        selectEl.innerHTML = "";
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = placeholder;
        selectEl.appendChild(opt);
        for (const v of sorted) {
          const o = document.createElement("option");
          o.value = v;
          o.textContent = v;
          selectEl.appendChild(o);
        }
      }

      function buildFilters(rows) {
        const teams = new Set();
        const players = new Set();
        const series = new Set();
        const sets = new Set();
        const tiers = new Set();
        const positions = new Set();

        for (const r of rows) {
          if (r.team_name) teams.add(r.team_name);
          if (r.player_name && r.player_name.trim()) players.add(r.player_name.trim());
          if (r.series_name) series.add(r.series_name);
          if (r.set_name) sets.add(r.set_name);
          if (r.tier) tiers.add(r.tier);
          if (r.position) positions.add(r.position);
        }

        fillSelect(filterTeam, teams, "All teams");
        fillSelect(filterPlayer, players, "All players");
        fillSelect(filterSeries, series, "All series");
        fillSelect(filterSet, sets, "All sets");
        fillSelect(filterTier, tiers, "All tiers");
        fillSelect(filterPosition, positions, "All positions");
        filterLocked.value = "";
      }

      function applyFilters() {
        const t = filterTeam.value;
        const p = filterPlayer.value;
        const s = filterSeries.value;
        const set = filterSet.value;
        const tier = filterTier.value;
        const pos = filterPosition.value;
        const locked = filterLocked.value;

        const filtered = allRows.filter((r) => {
          if (t && r.team_name !== t) return false;
          if (p && (r.player_name || "").trim() !== p) return false;
          if (s && r.series_name !== s) return false;
          if (set && r.set_name !== set) return false;
          if (tier && r.tier !== tier) return false;
          if (pos && r.position !== pos) return false;
          if (locked === "locked" && !r.is_locked) return false;
          if (locked === "unlocked" && r.is_locked) return false;
          return true;
        });

        currentFilteredRows = filtered;
        renderSummary(filtered);
        renderTable(filtered);
      }

      function resetFilters() {
        filterTeam.value = "";
        filterPlayer.value = "";
        filterSeries.value = "";
        filterSet.value = "";
        filterTier.value = "";
        filterPosition.value = "";
        filterLocked.value = "";
        applyFilters();
      }

      function renderSummary(rows) {
        if (!rows.length) {
          summaryRowEl.style.display = "none";
          return;
        }
        const total = rows.length;
        const locked = rows.filter((r) => r.is_locked).length;
        const unlocked = total - locked;
        const lowAskSum = rows.reduce((acc, r) => acc + (r.low_ask != null ? Number(r.low_ask) : 0), 0);
        const aspSum = rows.reduce((acc, r) => acc + (r.asp_90d != null ? Number(r.asp_90d) : 0), 0);

        summaryTotalEl.textContent = total;
        summaryUnlockedEl.textContent = unlocked;
        summaryLockedEl.textContent = locked;
        summaryLowAskEl.textContent = formatCurrency(lowAskSum);
        summaryAspEl.textContent = formatCurrency(aspSum);
        summaryRowEl.style.display = "grid";
      }

      function setSortIndicator() {
        const ths = document.querySelectorAll("th.sortable");
        ths.forEach((th) => {
          const span = th.querySelector(".sort-indicator");
          if (!span) return;
          const key = th.getAttribute("data-sort-key");
          if (key === currentSort.key) {
            span.textContent = currentSort.dir === "asc" ? "▲" : "▼";
          } else {
            span.textContent = "";
          }
        });
      }

      function compareRows(a, b, sort) {
        const dir = sort.dir === "asc" ? 1 : -1;
        const key = sort.key;

        function num(v) {
          return v == null || isNaN(v) ? null : Number(v);
        }

        let av, bv;

        switch (key) {
          case "player":
            av = (a.player_name || "").toLowerCase();
            bv = (b.player_name || "").toLowerCase();
            return av.localeCompare(bv) * dir;
          case "team":
            av = (a.team_name || "").toLowerCase();
            bv = (b.team_name || "").toLowerCase();
            return av.localeCompare(bv) * dir;
          case "position":
            av = (a.position || "").toLowerCase();
            bv = (b.position || "").toLowerCase();
            return av.localeCompare(bv) * dir;
          case "tier":
            av = (a.tier || "").toLowerCase();
            bv = (b.tier || "").toLowerCase();
            return av.localeCompare(bv) * dir;
          case "series":
            av = (a.series_name || "").toLowerCase();
            bv = (b.series_name || "").toLowerCase();
            return av.localeCompare(bv) * dir;
          case "set":
            av = (a.set_name || "").toLowerCase();
            bv = (b.set_name || "").toLowerCase();
            return av.localeCompare(bv) * dir;
          case "serial":
            av = num(a.serial_number);
            bv = num(b.serial_number);
            break;
          case "lowAsk":
            av = num(a.low_ask);
            bv = num(b.low_ask);
            break;
          case "asp":
            av = num(a.asp_90d);
            bv = num(b.asp_90d);
            break;
          case "locked":
            av = a.is_locked ? 1 : 0;
            bv = b.is_locked ? 1 : 0;
            break;
          case "date":
          default:
            av = a.last_event_ts ? Date.parse(a.last_event_ts) : 0;
            bv = b.last_event_ts ? Date.parse(b.last_event_ts) : 0;
            break;
        }

        if (av == null && bv == null) return 0;
        if (av == null) return 1 * dir;
        if (bv == null) return -1 * dir;
        if (av === bv) return 0;
        return av < bv ? -1 * dir : 1 * dir;
      }

      function renderTable(rows) {
        if (!rows.length) {
          tableContainerEl.style.display = "none";
          emptyStateEl.style.display = "block";
          resultsBody.innerHTML = "";
          return;
        }

        const sorted = [...rows].sort((a, b) => compareRows(a, b, currentSort));
        setSortIndicator();

        const html = sorted
          .map((r) => {
            const playerName = r.player_name || ((r.first_name || "") + " " + (r.last_name || "")).trim();
            const team = r.team_name || "";
            const pos = r.position || "";
            const tier = r.tier || "";
            const series = r.series_name || "";
            const setName = r.set_name || "";
            const serialStr = r.serial_number != null ? "#" + r.serial_number : "";
            const maxStr = r.max_mint_size != null ? " / " + r.max_mint_size : "";
            const lockedLabel = r.is_locked ? "Locked" : "Unlocked";
            const lockedClass = r.is_locked ? "badge badge-locked" : "badge badge-unlocked";
            const lowAskStr = r.low_ask != null ? formatCurrency(r.low_ask) : "";
            const aspStr = r.asp_90d != null ? formatCurrency(r.asp_90d) : "";
            const lastEvent = formatDate(r.last_event_ts);
            const momentUrl = r.nfl_allday_url || (r.nft_id ? `https://nflallday.com/moments/${r.nft_id}` : "");
            const listingUrl =
              r.listing_url || (r.edition_id ? `https://nflallday.com/listing/moment/${r.edition_id}` : "");

            return `
            <tr>
              <td>
                <div class="player-cell">
                  <span class="player-name">${playerName || "-"}</span>
                  <span class="player-meta">${team || ""}</span>
                </div>
              </td>
              <td>${team || "-"}</td>
              <td>${pos || "-"}</td>
              <td><span class="badge badge-tier">${tier || "-"}</span></td>
              <td>${series || "-"}</td>
              <td>${setName || "-"}</td>
              <td class="num">${serialStr}${maxStr}</td>
              <td class="num">${lowAskStr || ""}</td>
              <td class="num">${aspStr || ""}</td>
              <td><span class="${lockedClass}">${lockedLabel}</span></td>
              <td>${lastEvent || ""}</td>
              <td class="link-cell">
                ${momentUrl ? `<a href="${momentUrl}" target="_blank">Moment</a>` : ""}
                ${listingUrl ? ` · <a href="${listingUrl}" target="_blank">Listing</a>` : ""}
              </td>
            </tr>
          `;
          })
          .join("");

        resultsBody.innerHTML = html;
        tableContainerEl.style.display = "block";
        emptyStateEl.style.display = "none";
      }

      async function fetchWallet(wallet) {
        currentWallet = wallet;
        setStatus("Loading wallet...");
        walletHeaderEl.textContent = "";
        summaryRowEl.style.display = "none";
        tableContainerEl.style.display = "none";
        emptyStateEl.style.display = "none";
        resultsBody.innerHTML = "";

        try {
          const [profile, queryRes] = await Promise.all([
            fetchProfile(wallet),
            fetch(`/api/query?wallet=${encodeURIComponent(wallet)}`).then((r) => r.json())
          ]);

          if (!queryRes.ok) {
            setStatus(queryRes.error || "Error loading wallet", true);
            return;
          }

          const rows = queryRes.rows || [];
          allRows = rows;

          if (profile && profile.display_name) {
            walletHeaderEl.innerHTML = `${profile.display_name} <span class="address">(${wallet})</span>`;
          } else {
            walletHeaderEl.textContent = wallet;
          }

          if (!rows.length) {
            setStatus("Wallet has no moments.");
            emptyStateEl.style.display = "block";
            return;
          }

          // prices
          const editionIds = rows.map((r) => r.edition_id).filter((x) => x != null);
          const priceData = await fetchPrices(editionIds);

          const aspMap = priceData.asp || {};
          const lowAskMap = priceData.lowAsk || {};

          allRows = rows.map((r) => ({
            ...r,
            asp_90d: r.edition_id && aspMap[r.edition_id] != null ? Number(aspMap[r.edition_id]) : null,
            low_ask: r.edition_id && lowAskMap[r.edition_id] != null ? Number(lowAskMap[r.edition_id]) : null
          }));

          buildFilters(allRows);
          applyFilters();
          setStatus(`Loaded ${allRows.length} moments.`);
        } catch (err) {
          console.error(err);
          setStatus("Error loading wallet.", true);
        }
      }

      walletForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const wallet = walletInput.value.trim().toLowerCase();
        if (!wallet) return;
        const params = new URLSearchParams(window.location.search);
        params.set("wallet", wallet);
        const newUrl = window.location.pathname + "?" + params.toString();
        window.history.replaceState({}, "", newUrl);
        fetchWallet(wallet);
      });

      resetFiltersBtn.addEventListener("click", () => {
        resetFilters();
      });

      [filterTeam, filterPlayer, filterSeries, filterSet, filterTier, filterPosition, filterLocked].forEach((el) => {
        el.addEventListener("change", applyFilters);
      });

      const sortableHeaders = document.querySelectorAll("th.sortable");
      sortableHeaders.forEach((th) => {
        th.addEventListener("click", () => {
          const key = th.getAttribute("data-sort-key");
          if (!key) return;
          if (currentSort.key === key) {
            currentSort.dir = currentSort.dir === "asc" ? "desc" : "asc";
          } else {
            currentSort.key = key;
            currentSort.dir = key === "date" ? "desc" : "asc";
          }
          renderTable(currentFilteredRows);
        });
      });

      // Auto-load if wallet= is in URL
      (function initFromUrl() {
        const params = new URLSearchParams(window.location.search);
        const w = params.get("wallet");
        if (w) {
          walletInput.value = w;
          fetchWallet(w.toLowerCase());
        }
      })();
    </script>
  </body>
</html>
