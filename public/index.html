<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Chunky's NFLAD Viewer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/header.css" />
    <style>
      :root {
        --bg-main: #050816;
        --bg-card: #101322;
        --border-subtle: rgba(255, 255, 255, 0.06);
        --text-main: #f9fafb;
        --text-muted: #9ca3af;
        --accent-purple: #6f42c1;
        --accent-blue: #007bff;
        --accent-cyan: #0dcaf0;
        --accent-teal: #17a2b8;
        --accent-alt: #00cccc;
        --danger: #f97373;
        --success: #22c55e;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family:
          system-ui,
          -apple-system,
          BlinkMacSystemFont,
          "Segoe UI",
          sans-serif;
        background: radial-gradient(circle at top, #1e293b 0, #020617 55%);
        color: var(--text-main);
      }

      a {
        color: var(--accent-cyan);
        text-decoration: none;
      }

      a:hover {
        text-decoration: underline;
      }

      .app-shell {
        max-width: 95%;
        margin: 0 auto;
        padding: 1.5rem 4%;
        min-height: 100vh;
      }

      .app-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        margin-bottom: 1rem;
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .brand-logo {
        width: 36px;
        height: 36px;
        border-radius: 999px;
        background: radial-gradient(circle at 30% 20%, #facc15, #ec4899);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.4rem;
      }

      .brand-logo img {
        width: 24px;
        height: 24px;
        border-radius: 50%;
      }

      .brand-title {
        font-weight: 700;
        letter-spacing: 0.03em;
        text-transform: uppercase;
        font-size: 0.95rem;
      }

      .wallet-form {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex: 0 0 420px;
      }

      #wallet-input {
        flex: 1;
        border-radius: 999px;
        border: 1px solid var(--border-subtle);
        padding: 0.5rem 0.9rem;
        background: rgba(15, 23, 42, 0.9);
        color: var(--text-main);
        font-size: 0.9rem;
      }

      #wallet-input::placeholder {
        color: var(--text-muted);
      }

      .btn-primary {
        border-radius: 999px;
        border: none;
        padding: 0.5rem 1.1rem;
        background: linear-gradient(135deg, var(--accent-purple), var(--accent-blue));
        color: white;
        font-weight: 600;
        font-size: 0.9rem;
        cursor: pointer;
        white-space: nowrap;
      }

      .btn-primary:hover {
        filter: brightness(1.05);
      }

      .btn-secondary {
        border-radius: 999px;
        border: 1px solid var(--border-subtle);
        padding: 0.3rem 0.8rem;
        background: transparent;
        color: var(--text-muted);
        font-size: 0.78rem;
        cursor: pointer;
      }

      .btn-secondary:hover {
        border-color: var(--accent-cyan);
        color: var(--accent-cyan);
      }

      .wallet-summary-card {
        margin-bottom: 1rem;
        padding: 1rem 1.25rem;
        border-radius: 0.75rem;
        background: rgba(15, 15, 30, 0.9);
        border: 1px solid var(--border-subtle);
        display: none;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
        gap: 0.75rem;
      }

      .wallet-summary-main {
        display: flex;
        flex-direction: column;
        gap: 0.1rem;
      }

      .wallet-summary-label {
        font-size: 0.75rem;
        color: var(--text-muted);
      }

      .wallet-summary-address {
        font-weight: 600;
        font-size: 0.9rem;
      }

      .wallet-summary-chips {
        display: flex;
        flex-wrap: wrap;
        gap: 0.4rem;
        font-size: 0.75rem;
      }

      .chip {
        border-radius: 999px;
        padding: 0.2rem 0.7rem;
        border: 1px solid rgba(255, 255, 255, 0.08);
        background: rgba(15, 23, 42, 0.9);
      }

      .chip-pill-tier {
        border-radius: 999px;
        padding: 0.15rem 0.6rem;
        font-size: 0.7rem;
        font-weight: 500;
        transition: opacity 0.2s, transform 0.1s;
      }

      .chip-pill-tier:hover {
        opacity: 0.8;
        transform: scale(1.05);
      }

      .chip-common {
        background: #4b5563;
        color: #e5e7eb;
      }

      .chip-uncommon {
        background: #6b7280;
        color: #e5e7eb;
      }

      .chip-rare {
        background: #f97316;
        color: #111827;
      }

      .chip-legendary {
        background: linear-gradient(135deg, #facc15, #f97316);
        color: #111827;
      }

      .chip-ultimate {
        background: linear-gradient(135deg, #ec4899, #6366f1, #22c55e);
        color: white;
      }

      .content {
        display: grid;
        grid-template-columns: minmax(110px, 260px) minmax(0, 1fr);
        gap: 1.25rem;
        align-items: flex-start;
      }

      .filters-panel {
        background: var(--bg-card);
        border-radius: 0.75rem;
        border: 1px solid var(--border-subtle);
        padding: 1rem 1.25rem;
        font-size: 0.85rem;
      }

      .filters-panel h3 {
        margin: 0 0 0.75rem;
        font-size: 0.8rem;
        letter-spacing: 0.09em;
        text-transform: uppercase;
        color: var(--text-muted);
      }

      .filter-group {
        margin-bottom: 0.65rem;
      }

      .filter-group label {
        display: block;
        font-size: 0.7rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--text-muted);
        margin-bottom: 0.15rem;
      }

      .filter-select {
        width: 100%;
        border-radius: 0.5rem;
        border: 1px solid var(--border-subtle);
        background: #020617;
        color: var(--text-main);
        padding: 0.35rem 0.6rem;
        font-size: 0.8rem;
      }

      .reset-filters {
        margin-top: 0.4rem;
        border: none;
        background: none;
        color: var(--accent-cyan);
        font-size: 0.75rem;
        cursor: pointer;
        padding: 0;
      }

      .table-panel {
        background: var(--bg-card);
        border-radius: 0.75rem;
        border: 1px solid var(--border-subtle);
        padding: 0.75rem 0.75rem 0.5rem;
        display: flex;
        flex-direction: column;
        min-width: 0;
      }

      .table-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.5rem;
        margin-bottom: 0.35rem;
      }

      #moments-title {
        font-size: 0.85rem;
        font-weight: 500;
        color: var(--text-muted);
      }

      .export-btn {
        border-radius: 999px;
        border: 1px solid var(--accent-teal);
        background: transparent;
        color: var(--accent-teal);
        font-size: 0.8rem;
        padding: 0.3rem 0.8rem;
        cursor: pointer;
      }

      .export-btn:hover {
        background: rgba(13, 148, 136, 0.1);
      }

      .table-wrapper {
        overflow-x: auto;
        max-height: 80vh;
        width: 100%;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.78rem;
        table-layout: auto;
      }

      thead {
        position: sticky;
        top: 0;
        z-index: 1;
        background: #020617;
      }

      th,
      td {
        padding: 0.25rem 0.4rem;
        text-align: left;
        white-space: nowrap;
      }

      th {
        font-size: 0.72rem;
        color: var(--text-muted);
        font-weight: 500;
        border-bottom: 1px solid var(--border-subtle);
        cursor: pointer;
      }

      th.sortable:hover {
        color: var(--accent-cyan);
      }

      th.sort-asc::after {
        content: " ▲";
        font-size: 0.65em;
      }

      th.sort-desc::after {
        content: " ▼";
        font-size: 0.65em;
      }

      tbody tr:nth-child(2n) {
        background: rgba(15, 23, 42, 0.7);
      }

      tbody tr:nth-child(2n + 1) {
        background: rgba(15, 23, 42, 0.4);
      }

      tbody tr:hover {
        background: rgba(37, 99, 235, 0.25);
      }

      .locked-pill {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.1rem 0.5rem;
        border-radius: 999px;
        font-size: 0.7rem;
        font-weight: 500;
      }

      .locked-pill.locked {
        background: rgba(236, 72, 153, 0.15);
        color: #f472b6;
        border: 1px solid rgba(236, 72, 153, 0.7);
      }

      .locked-pill.unlocked {
        background: rgba(16, 185, 129, 0.15);
        color: #6ee7b7;
        border: 1px solid rgba(16, 185, 129, 0.7);
      }

      .link-group {
        display: flex;
        flex-direction: column;
        gap: 0.1rem;
        font-size: 0.72rem;
      }

      .link-group a {
        color: var(--accent-cyan);
      }

      .link-group a:hover {
        text-decoration: underline;
      }

      /* Profile Search Styles */
      .profile-search-section {
        margin-bottom: 1.25rem;
        padding: 0;
      }

      .profile-search-card {
        background: radial-gradient(circle at top left, #171d34 0, #050915 55%);
        border-radius: 0.75rem;
        border: 1px solid var(--border-subtle);
        padding: 1.2rem;
        box-shadow: 0 18px 40px rgba(0, 0, 0, 0.5);
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        max-height: 400px;
      }

      .profiles-title {
        font-size: 0.95rem;
        font-weight: 600;
      }

      .profiles-help {
        font-size: 0.78rem;
        color: var(--text-muted);
      }

      .search-label {
        font-size: 0.78rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        margin-bottom: 0.25rem;
        color: var(--text-muted);
      }

      .search-input {
        width: 100%;
        background: rgba(15, 23, 42, 0.9);
        border-radius: 999px;
        border: 1px solid var(--border-subtle);
        padding: 0.4rem 0.75rem;
        color: var(--text-main);
        font-size: 0.85rem;
        outline: none;
      }

      .search-input::placeholder {
        color: var(--text-muted);
      }

      .profiles-status {
        font-size: 0.78rem;
        color: var(--text-muted);
      }

      .profiles-list {
        margin-top: 0.25rem;
        padding: 0;
        list-style: none;
        overflow: auto;
        flex: 1 1 auto;
      }

      .profile-item-btn {
        width: 100%;
        text-align: left;
        background: rgba(15, 23, 42, 0.7);
        border-radius: 0.5rem;
        border: 1px solid var(--border-subtle);
        padding: 0.5rem 0.6rem;
        margin-bottom: 0.35rem;
        cursor: pointer;
        font-size: 0.78rem;
        color: var(--text-main);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.5rem;
      }

      .profile-item-btn:hover {
        border-color: var(--accent-cyan);
        background: rgba(15, 23, 42, 0.9);
      }

      .profile-item-btn.active {
        border-color: var(--accent-blue);
        background: rgba(37, 99, 235, 0.3);
      }

      .profile-item-main {
        min-width: 0;
      }

      .profile-item-name {
        font-weight: 600;
        font-size: 0.8rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .profile-item-address {
        font-size: 0.7rem;
        color: var(--text-muted);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-family: ui-monospace, monospace;
      }

      .profile-item-stats {
        text-align: right;
        font-size: 0.7rem;
        white-space: nowrap;
      }

      .profile-item-stats .unlocked {
        color: #22c55e;
      }

      @media (max-width: 960px) {
        .content {
          grid-template-columns: minmax(0, 1fr);
        }
        .profile-search-card {
          max-height: 300px;
        }
      }
    </style>
  </head>
  <body>
    <link rel="stylesheet" href="/header.css" />
    <div id="app-header"></div>
    <script src="/layout.js"></script>
    <div class="app-shell">

      <main class="content">
        <aside class="filters-panel">
          <!-- Profile Search Section -->
          <section id="profile-search-section" class="profile-search-section">
            <div class="profile-search-card">
              <div class="profiles-title">Search profiles</div>
              <div>
                <input
                  id="prof-search-input"
                  type="text"
                  class="search-input"
                  placeholder="Display name or wallet address..."
                  autocomplete="off"
                />
              </div>
              <div id="prof-status" class="profiles-status">
                Start typing to search.
              </div>
              <ul id="prof-list" class="profiles-list"></ul>
            </div>
          </section>

          <h3>Filters</h3>

          <div class="filter-group">
            <label for="filter-team">Team</label>
            <select id="filter-team" class="filter-select"></select>
          </div>

          <div class="filter-group">
            <label for="filter-player">Player</label>
            <select id="filter-player" class="filter-select"></select>
          </div>

          <div class="filter-group">
            <label for="filter-series">Series</label>
            <select id="filter-series" class="filter-select"></select>
          </div>

          <div class="filter-group">
            <label for="filter-set">Set</label>
            <select id="filter-set" class="filter-select"></select>
          </div>

          <div class="filter-group">
            <label for="filter-tier">Tier</label>
            <select id="filter-tier" class="filter-select"></select>
          </div>

          <div class="filter-group">
            <label for="filter-position">Position</label>
            <select id="filter-position" class="filter-select"></select>
          </div>

          <div class="filter-group">
            <label for="filter-locked">Locked status</label>
            <select id="filter-locked" class="filter-select"></select>
          </div>

          <button id="reset-filters" class="reset-filters">Reset filters</button>
        </aside>

        <section class="table-panel">
          <section id="wallet-summary-card" class="wallet-summary-card"></section>
          <div class="table-header">
            <h3 id="moments-title">Moments</h3>
            <button id="export-csv" class="export-btn">Export CSV</button>
          </div>

          <div class="table-wrapper">
            <table id="wallet-table">
              <thead>
                <tr>
                  <th class="sortable" data-sort-key="playerName">Player</th>
                  <th class="sortable" data-sort-key="team_name">Team</th>
                  <th class="sortable" data-sort-key="position">Pos</th>
                  <th class="sortable" data-sort-key="tier">Tier</th>
                  <th class="sortable" data-sort-key="serial_number">Serial</th>
                  <th class="sortable" data-sort-key="max_mint_size">Max</th>
                  <th class="sortable" data-sort-key="series_name">Series</th>
                  <th class="sortable" data-sort-key="set_name">Set</th>
                  <th class="sortable" data-sort-key="low_ask_usd">Low Ask</th>
                  <th class="sortable" data-sort-key="avg_sale_usd">Avg Sale</th>
                  <th class="sortable" data-sort-key="top_sale_usd">Top Sale</th>
                  <th class="sortable" data-sort-key="is_locked">Locked</th>
                  <th class="sortable" data-sort-key="last_event_ts">Last event</th>
                  <th>Links</th>
                </tr>
              </thead>
              <tbody id="wallet-tbody"></tbody>
            </table>

            <div
              id="wallet-pager"
              style="margin-top: 0.75rem; display: flex; gap: 0.5rem; align-items: center; font-size: 0.8rem">
              <button id="wallet-page-prev" class="btn-secondary" type="button">Prev</button>
              <button id="wallet-page-next" class="btn-secondary" type="button">Next</button>
              <span id="wallet-page-info"></span>
            </div>
          </div>
        </section>
      </main>
    </div>

    <script>
      (function () {
        async function updateNavAccount() {
          const link = document.getElementById("nav-account-link");
          if (!link) return;

          try {
            const res = await fetch("/api/me");
            const data = await res.json();

            if (data && data.user) {
              link.href = "/login.html";
              link.textContent = data.user.email;
            } else {
              link.href = "/login.html";
              link.textContent = "Login";
            }
          } catch (err) {
            console.error("updateNavAccount error:", err);
          }
        }

        updateNavAccount();
      })();
    </script>

    <script>
      async function maybeLoadDefaultWallet() {
        const params = new URLSearchParams(window.location.search);
        const walletFromUrl = (params.get("wallet") || "").trim();
        if (walletFromUrl) {
          if (typeof window.runQuery === "function") {
            window.runQuery(walletFromUrl);
          } else if (typeof window.loadWallet === "function") {
            window.loadWallet(walletFromUrl);
          }
          return;
        }

        try {
          const res = await fetch("/api/me", { credentials: "include" });
          if (!res.ok) {
            console.warn("GET /api/me failed with HTTP", res.status);
            return;
          }
          const data = await res.json();
          if (!data.ok || !data.user || !data.user.default_wallet_address) {
            return;
          }

          const wallet = (data.user.default_wallet_address || "").trim();
          if (!wallet) return;

          if (typeof window.runQuery === "function") {
            window.runQuery(wallet);
          } else if (typeof window.loadWallet === "function") {
            window.loadWallet(wallet);
          } else {
            console.warn("No runQuery/loadWallet function found to load wallet automatically");
          }
        } catch (err) {
          console.error("Failed to auto-load default wallet:", err);
        }
      }

      document.addEventListener("DOMContentLoaded", maybeLoadDefaultWallet);
    </script>

    <script src="app.js"></script>
    <script>
      // Profile search functionality
      (function () {
        const searchInput = document.getElementById("prof-search-input");
        const statusEl = document.getElementById("prof-status");
        const listEl = document.getElementById("prof-list");

        if (!searchInput || !statusEl || !listEl) {
          console.warn("Profile search elements not found");
          return;
        }

        let currentProfiles = [];
        let currentSelectedIndex = -1;
        let searchTimeout = null;

        function formatNumber(n) {
          if (n == null) return "0";
          return Number(n).toLocaleString();
        }

        function renderList() {
          listEl.innerHTML = "";

          if (!currentProfiles.length) {
            const li = document.createElement("li");
            li.className = "profiles-help";
            li.textContent = "No profiles found for this search.";
            listEl.appendChild(li);
            return;
          }

          currentProfiles.forEach((p, idx) => {
            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = "profile-item-btn" + (idx === currentSelectedIndex ? " active" : "");
            btn.dataset.index = String(idx);

            const mainDiv = document.createElement("div");
            mainDiv.className = "profile-item-main";

            const nameDiv = document.createElement("div");
            nameDiv.className = "profile-item-name";
            nameDiv.textContent = p.display_name || "(unknown)";

            const addrDiv = document.createElement("div");
            addrDiv.className = "profile-item-address";
            addrDiv.textContent = p.wallet_address || "";

            mainDiv.appendChild(nameDiv);
            mainDiv.appendChild(addrDiv);

            const statsDiv = document.createElement("div");
            statsDiv.className = "profile-item-stats";
            statsDiv.innerHTML =
              '<div>' +
              formatNumber(p.total_moments) +
              " moments</div>" +
              '<div class="unlocked">' +
              formatNumber(p.unlocked_moments) +
              " unlocked</div>";

            btn.appendChild(mainDiv);
            btn.appendChild(statsDiv);

            btn.addEventListener("click", () => {
              currentSelectedIndex = idx;
              renderList();
              loadWalletFromProfile(p);
            });

            const li = document.createElement("li");
            li.appendChild(btn);
            listEl.appendChild(li);
          });
        }

        async function loadWalletFromProfile(profile) {
          const walletAddress = profile.wallet_address;
          if (!walletAddress) return;

          // Update the wallet input field
          const walletInput = document.getElementById("wallet-input");
          if (walletInput) {
            walletInput.value = walletAddress;
          }

          // Load the wallet using the existing runQuery function
          if (window.runQuery) {
            await window.runQuery(walletAddress);
          }

          // Scroll to top to show the wallet summary
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function runSearch(term) {
          const trimmed = term.trim();

          if (!trimmed) {
            currentProfiles = [];
            currentSelectedIndex = -1;
            statusEl.textContent = "Start typing to search for profiles.";
            listEl.innerHTML = "";
            return;
          }

          statusEl.textContent = "Searching…";

          try {
            const res = await fetch(
              "/api/profiles?query=" + encodeURIComponent(trimmed)
            );
            const data = await res.json();

            if (!res.ok || !data.ok) {
              throw new Error(data.error || "Search failed");
            }

            currentProfiles = data.profiles || [];
            currentSelectedIndex = currentProfiles.length ? 0 : -1;

            if (!currentProfiles.length) {
              statusEl.textContent = "No profiles found for \"" + trimmed + "\".";
            } else {
              statusEl.textContent =
                "Found " +
                currentProfiles.length +
                " profile(s) for \"" +
                trimmed +
                "\".";
            }

            renderList();
          } catch (err) {
            console.error("profiles search error:", err);
            statusEl.textContent = "Search failed: " + (err.message || "Check console for details.");
            currentProfiles = [];
            currentSelectedIndex = -1;
            renderList();
          }
        }

        searchInput.addEventListener("input", () => {
          const value = searchInput.value;
          if (searchTimeout) clearTimeout(searchTimeout);
          searchTimeout = setTimeout(() => runSearch(value), 300);
        });
      })();
    </script>
  </body>
</html>
