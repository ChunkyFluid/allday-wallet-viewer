<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Login – Chunky's NFLAD Viewer</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="stylesheet" href="/header.css" />
        <style>
            :root {
                --bg-main: #050816;
                --bg-card: #101322;
                --border-subtle: rgba(255, 255, 255, 0.06);
                --text-main: #f9fafb;
                --text-muted: #9ca3af;
                --accent-purple: #6f42c1;
                --accent-blue: #007bff;
                --accent-cyan: #0dcaf0;
            }

            * {
                box-sizing: border-box;
            }

            body {
                margin: 0;
                font-family:
                    system-ui,
                    -apple-system,
                    BlinkMacSystemFont,
                    "Segoe UI",
                    sans-serif;
                background: radial-gradient(circle at top, #1e293b 0, #020617 55%);
                color: var(--text-main);
            }

            a {
                color: var(--accent-cyan);
                text-decoration: none;
            }

            a:hover {
                text-decoration: underline;
            }

            .app-shell {
                max-width: 95%;
                margin: 0 auto;
                padding: 1.5rem 4%;
                min-height: 100vh;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .login-wrapper {
                width: 100%;
                max-width: 420px;
            }

            .login-card {
                background: var(--bg-card);
                border: 1px solid var(--border-subtle);
                border-radius: 12px;
                padding: 2rem;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            }

            .login-title {
                font-size: 1.5rem;
                font-weight: 700;
                margin-bottom: 0.5rem;
                color: var(--text-main);
            }

            .login-subtitle {
                font-size: 0.9rem;
                color: var(--text-muted);
                margin-bottom: 1.5rem;
                line-height: 1.5;
            }

            .btn-primary {
                background: linear-gradient(135deg, var(--accent-blue) 0%, #0056b3 100%);
                color: white;
                border: none;
                padding: 0.75rem 1.5rem;
                border-radius: 8px;
                font-size: 1rem;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s;
                width: 100%;
            }

            .btn-primary:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0, 123, 255, 0.4);
            }

            .btn-primary:active {
                transform: translateY(0);
            }

            .btn-secondary {
                background: transparent;
                border: 1px solid var(--border-subtle);
                color: var(--text-main);
                border-radius: 999px;
                cursor: pointer;
                transition: all 0.15s ease;
            }

            .btn-secondary:hover {
                background: rgba(255, 255, 255, 0.05);
                border-color: var(--accent-blue);
            }

            .btn-google {
                background: white;
                color: #333;
                border: 1px solid #dadce0;
                padding: 0.75rem 1.5rem;
                border-radius: 8px;
                font-size: 1rem;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.2s;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .btn-google:hover {
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
                background: #f8f9fa;
            }

            .status {
                margin-top: 1rem;
                font-size: 0.8rem;
                color: var(--text-muted);
                min-height: 1.2em;
            }

            .status.error {
                color: #f97373;
            }

            .status.success {
                color: #4ade80;
            }

            input[type="email"],
            input[type="password"] {
                width: 100%;
                padding: 0.75rem;
                background: var(--bg-main);
                border: 1px solid var(--border-subtle);
                border-radius: 6px;
                color: var(--text-main);
                font-size: 1rem;
            }

            input[type="email"]:focus,
            input[type="password"]:focus {
                outline: none;
                border-color: var(--accent-blue);
            }

            label {
                display: block;
                margin-bottom: 0.5rem;
                font-size: 0.9rem;
                color: var(--text-muted);
            }
        </style>
        <link rel="stylesheet" href="/header.css" />
    </head>
    <body>
        <link rel="stylesheet" href="/header.css" />
        <div id="app-header"></div>
        <script src="/layout.js"></script>
        <div class="app-shell">

            <div class="login-wrapper">
                <section class="login-card">
                    <div class="login-title">Sign In</div>
                    <div class="login-subtitle">
                        Sign in to save your default wallet and access your personalized view.
                    </div>

                    <!-- Email/Password Login Form -->
                    <form id="login-form" style="display: none;">
                        <div style="margin-bottom: 1rem;">
                            <label for="email">Email</label>
                            <input 
                                type="email" 
                                id="email" 
                                name="email" 
                                required 
                                placeholder="your@email.com"
                            />
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label for="password">Password</label>
                            <input 
                                type="password" 
                                id="password" 
                                name="password" 
                                required 
                                placeholder="••••••••"
                            />
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label for="login-wallet">Default Wallet Address (optional)</label>
                            <input 
                                type="text" 
                                id="login-wallet" 
                                name="wallet" 
                                placeholder="0x..."
                                pattern="^0x[a-fA-F0-9]{16,64}$"
                                title="Flow wallet address starting with 0x"
                            />
                            <small style="display: block; margin-top: 0.25rem; font-size: 0.75rem; color: var(--text-muted);">
                                Your wallet will auto-load when you visit the page
                            </small>
                        </div>
                        <button type="submit" class="btn-primary" style="width: 100%; margin-bottom: 0.75rem;">
                            Sign In
                        </button>
                        <button type="button" id="btn-show-signup" class="btn-secondary" style="width: 100%; font-size: 0.9rem;">
                            Don't have an account? Sign up
                        </button>
                    </form>

                    <!-- Signup Form -->
                    <form id="signup-form" style="display: none;">
                        <div style="margin-bottom: 1rem;">
                            <label for="signup-email">Email</label>
                            <input 
                                type="email" 
                                id="signup-email" 
                                name="email" 
                                required 
                                placeholder="your@email.com"
                            />
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label for="signup-password">Password (min 8 characters)</label>
                            <input 
                                type="password" 
                                id="signup-password" 
                                name="password" 
                                required 
                                minlength="8"
                                placeholder="••••••••"
                            />
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label for="signup-wallet">Default Wallet Address (optional)</label>
                            <input 
                                type="text" 
                                id="signup-wallet" 
                                name="wallet" 
                                placeholder="0x..."
                                pattern="^0x[a-fA-F0-9]{16,64}$"
                                title="Flow wallet address starting with 0x"
                            />
                            <small style="display: block; margin-top: 0.25rem; font-size: 0.75rem; color: var(--text-muted);">
                                Your wallet will auto-load when you visit the page
                            </small>
                        </div>
                        <button type="submit" class="btn-primary" style="width: 100%; margin-bottom: 0.75rem;">
                            Create Account
                        </button>
                        <button type="button" id="btn-show-login" class="btn-secondary" style="width: 100%; font-size: 0.9rem;">
                            Already have an account? Sign in
                        </button>
                    </form>

                    <!-- Google OAuth Button -->
                    <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-subtle);">
                        <button id="btn-google-login" class="btn-google" type="button" style="width: 100%;">
                            <svg width="18" height="18" viewBox="0 0 18 18" style="margin-right: 0.5rem;">
                                <path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z"/>
                                <path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.96-2.184l-2.908-2.258c-.806.54-1.837.86-3.052.86-2.35 0-4.34-1.587-5.052-3.72H.957v2.332C2.438 15.983 5.482 18 9 18z"/>
                                <path fill="#FBBC05" d="M3.948 10.718c-.18-.54-.282-1.117-.282-1.718 0-.601.102-1.178.282-1.718V4.95H.957C.348 6.174 0 7.55 0 9c0 1.45.348 2.826.957 4.05l2.991-2.332z"/>
                                <path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.95L3.948 7.282C4.66 5.147 6.65 3.58 9 3.58z"/>
                            </svg>
                            Sign in with Google
                        </button>
                    </div>

                    <button id="btn-logout" class="btn-secondary" type="button" style="display: none; width: 100%; margin-top: 0.5rem; padding: 0.6rem 1rem; font-size: 0.9rem;">
                        <span>Logout</span>
                    </button>

                    <div id="login-status" class="status"></div>
                </section>
            </div>
        </div>

        <script>
            const statusEl = document.getElementById("login-status");
            const loginForm = document.getElementById("login-form");
            const signupForm = document.getElementById("signup-form");
            const btnShowSignup = document.getElementById("btn-show-signup");
            const btnShowLogin = document.getElementById("btn-show-login");
            const btnLogout = document.getElementById("btn-logout");
            const btnGoogle = document.getElementById("btn-google-login");

            function setStatus(msg, type) {
                if (!statusEl) return;
                statusEl.textContent = msg || "";
                statusEl.classList.remove("error", "success");
                if (type) statusEl.classList.add(type);
            }

            // Check if user is already logged in
            async function checkLoginStatus() {
                try {
                    const res = await fetch("/api/me", { credentials: "include" });
                    const data = await res.json();
                    if (data.ok && data.user) {
                        // User is logged in
                        loginForm.style.display = "none";
                        signupForm.style.display = "none";
                        btnGoogle.style.display = "none";
                        if (btnLogout) btnLogout.style.display = "block";
                        setStatus(`Logged in as ${data.user.email}`, "success");
                        return true;
                    } else {
                        // User is not logged in - show login form
                        loginForm.style.display = "block";
                        signupForm.style.display = "none";
                        if (btnLogout) btnLogout.style.display = "none";
                        return false;
                    }
                } catch (err) {
                    console.error("Error checking login status:", err);
                    loginForm.style.display = "block";
                    return false;
                }
            }

            // Toggle between login and signup forms
            if (btnShowSignup) {
                btnShowSignup.addEventListener("click", () => {
                    loginForm.style.display = "none";
                    signupForm.style.display = "block";
                });
            }

            if (btnShowLogin) {
                btnShowLogin.addEventListener("click", () => {
                    signupForm.style.display = "none";
                    loginForm.style.display = "block";
                });
            }

            // Login form submission
            if (loginForm) {
                loginForm.addEventListener("submit", async (e) => {
                    e.preventDefault();
                    setStatus("Signing in...", null);

                    const email = document.getElementById("email").value;
                    const password = document.getElementById("password").value;
                    const wallet = (document.getElementById("login-wallet").value || "").trim();

                    try {
                        const res = await fetch("/api/login", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            credentials: "include",
                            body: JSON.stringify({ email, password })
                        });

                        const data = await res.json();
                        if (res.ok && data.ok) {
                            // If wallet address provided, set it as default
                            if (wallet) {
                                try {
                                    // Normalize wallet address
                                    let walletAddr = wallet.toLowerCase().trim();
                                    if (!walletAddr.startsWith("0x")) {
                                        walletAddr = "0x" + walletAddr;
                                    }
                                    
                                    // Validate format
                                    if (!/^0x[a-f0-9]{16,64}$/.test(walletAddr)) {
                                        setStatus("Invalid wallet address format. Login successful but wallet not set.", "error");
                                        setTimeout(() => {
                                            window.location.href = "/";
                                        }, 2000);
                                        return;
                                    }
                                    
                                    const walletRes = await fetch("/api/me/wallet", {
                                        method: "POST",
                                        headers: { "Content-Type": "application/json" },
                                        credentials: "include",
                                        body: JSON.stringify({ wallet_address: walletAddr })
                                    });
                                    
                                    const walletData = await walletRes.json();
                                    if (walletRes.ok && walletData.ok) {
                                        setStatus("Login successful! Default wallet set. Redirecting...", "success");
                                    } else {
                                        setStatus("Login successful! Redirecting...", "success");
                                    }
                                } catch (walletErr) {
                                    console.error("Failed to set default wallet:", walletErr);
                                    setStatus("Login successful! Redirecting...", "success");
                                }
                            } else {
                                setStatus("Login successful! Redirecting...", "success");
                            }
                            
                            setTimeout(() => {
                                window.location.href = "/";
                            }, 500);
                        } else {
                            setStatus(data.error || "Login failed", "error");
                        }
                    } catch (err) {
                        console.error("Login error:", err);
                        setStatus("Failed to sign in. Please try again.", "error");
                    }
                });
            }

            // Signup form submission
            if (signupForm) {
                signupForm.addEventListener("submit", async (e) => {
                    e.preventDefault();
                    setStatus("Creating account...", null);

                    const email = document.getElementById("signup-email").value;
                    const password = document.getElementById("signup-password").value;
                    const wallet = (document.getElementById("signup-wallet").value || "").trim();

                    try {
                        const res = await fetch("/api/signup", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            credentials: "include",
                            body: JSON.stringify({ email, password })
                        });

                        const data = await res.json();
                        if (res.ok && data.ok) {
                            // If wallet address provided, set it as default
                            if (wallet) {
                                try {
                                    // Normalize wallet address
                                    let walletAddr = wallet.toLowerCase().trim();
                                    if (!walletAddr.startsWith("0x")) {
                                        walletAddr = "0x" + walletAddr;
                                    }
                                    
                                    // Validate format
                                    if (!/^0x[a-f0-9]{16,64}$/.test(walletAddr)) {
                                        setStatus("Invalid wallet address format. Account created but wallet not set.", "error");
                                        setTimeout(() => {
                                            window.location.href = "/";
                                        }, 2000);
                                        return;
                                    }
                                    
                                    const walletRes = await fetch("/api/me/wallet", {
                                        method: "POST",
                                        headers: { "Content-Type": "application/json" },
                                        credentials: "include",
                                        body: JSON.stringify({ wallet_address: walletAddr })
                                    });
                                    
                                    const walletData = await walletRes.json();
                                    if (walletRes.ok && walletData.ok) {
                                        setStatus("Account created! Default wallet set. Redirecting...", "success");
                                    } else {
                                        setStatus("Account created! Redirecting...", "success");
                                    }
                                } catch (walletErr) {
                                    console.error("Failed to set default wallet:", walletErr);
                                    setStatus("Account created! Redirecting...", "success");
                                }
                            } else {
                                setStatus("Account created! Redirecting...", "success");
                            }
                            
                            setTimeout(() => {
                                window.location.href = "/";
                            }, 500);
                        } else {
                            setStatus(data.error || "Signup failed", "error");
                        }
                    } catch (err) {
                        console.error("Signup error:", err);
                        setStatus("Failed to create account. Please try again.", "error");
                    }
                });
            }

            // Google OAuth (placeholder - requires Google Cloud setup)
            if (btnGoogle) {
                btnGoogle.addEventListener("click", () => {
                    setStatus("Google OAuth not yet configured. Please use email/password for now.", "error");
                    // TODO: Implement Google OAuth
                    // This requires setting up Google OAuth credentials in Google Cloud Console
                });
            }

            // Logout
            if (btnLogout) {
                btnLogout.addEventListener("click", async () => {
                    try {
                        setStatus("Logging out...", null);
                        const res = await fetch("/api/logout", {
                            method: "POST",
                            credentials: "include"
                        });

                        if (res.ok) {
                            setStatus("Logged out successfully.", "success");
                            setTimeout(() => {
                                window.location.reload();
                            }, 500);
                        } else {
                            setStatus("Failed to logout.", "error");
                        }
                    } catch (err) {
                        console.error("Logout error:", err);
                        setStatus("Error during logout.", "error");
                    }
                });
            }

            // Initialize on page load
            checkLoginStatus();
        </script>
    </body>
</html>
