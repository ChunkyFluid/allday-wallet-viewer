<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Trade Analyzer | NFL All Day</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="header.css" />
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
  <style>
    :root { --bg: #050815; --card: #0b1020; --border: #1b2236; --text: #f8f9ff; --text-muted: #8c95b8; --accent1: #22c55e; --accent2: #3b82f6; --red: #ef4444; }
    body { background: radial-gradient(circle at top, #101526 0, #050815 55%); min-height: 100vh; font-family: 'Outfit', sans-serif; color: var(--text); margin: 0; }
    .container { max-width: 1400px; margin: 0 auto; padding: 2rem; }
    h1 { font-size: 2rem; background: linear-gradient(135deg, var(--accent1), var(--accent2)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 1.5rem; }
    .trade-setup { display: grid; grid-template-columns: 1fr auto 1fr; gap: 1.5rem; margin-bottom: 2rem; }
    .trade-side { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; }
    .trade-side.left { border-color: var(--accent1); }
    .trade-side.right { border-color: var(--accent2); }
    .trade-side h3 { margin: 0 0 1rem 0; display: flex; align-items: center; gap: 0.5rem; }
    .trade-side.left h3 { color: var(--accent1); }
    .trade-side.right h3 { color: var(--accent2); }
    .wallet-input { width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid var(--border); background: var(--bg); color: var(--text); margin-bottom: 1rem; }
    .trade-items { max-height: 400px; overflow-y: auto; }
    .trade-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: rgba(0,0,0,0.2); border-radius: 8px; margin-bottom: 0.5rem; }
    .trade-item .info { font-size: 0.9rem; }
    .trade-item .value { font-weight: 600; color: var(--accent1); }
    .trade-item .remove { cursor: pointer; color: var(--red); font-size: 1.2rem; }
    .vs-section { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 1rem; }
    .vs-icon { font-size: 2rem; margin-bottom: 1rem; }
    .analyze-btn { padding: 1rem 2rem; border-radius: 8px; border: none; background: linear-gradient(135deg, var(--accent1), var(--accent2)); color: white; font-weight: 600; cursor: pointer; font-size: 1rem; }
    .analyze-btn:hover { transform: translateY(-2px); }
    .analysis-result { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 2rem; margin-top: 2rem; }
    .analysis-header { text-align: center; margin-bottom: 2rem; }
    .analysis-verdict { font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem; }
    .analysis-verdict.fair { color: var(--accent1); }
    .analysis-verdict.unfair { color: var(--red); }
    .analysis-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; text-align: center; }
    .analysis-stat { padding: 1rem; background: rgba(0,0,0,0.2); border-radius: 8px; }
    .analysis-stat .value { font-size: 1.5rem; font-weight: 700; margin-bottom: 0.25rem; }
    .analysis-stat .label { font-size: 0.85rem; color: var(--text-muted); }
    .chip { display: inline-block; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.65rem; font-weight: 600; margin-left: 0.25rem; }
    .chip-common { background: rgba(156,163,175,0.2); color: #9ca3af; }
    .chip-uncommon { background: rgba(34,197,94,0.2); color: #22c55e; }
    .chip-rare { background: rgba(59,130,246,0.2); color: #3b82f6; }
    .chip-legendary { background: rgba(168,85,247,0.2); color: #a855f7; }
    .chip-ultimate { background: rgba(251,191,36,0.2); color: #fbbf24; }
    .empty-trade { text-align: center; padding: 2rem; color: var(--text-muted); }
    .search-results { max-height: 200px; overflow-y: auto; margin-bottom: 1rem; }
    .search-item { padding: 0.6rem 0.75rem; cursor: pointer; border-radius: 6px; display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .search-item:hover { background: rgba(255,255,255,0.1); }
    .search-item:last-child { border-bottom: none; }
    .total-value { padding: 1rem; background: rgba(0,0,0,0.3); border-radius: 8px; margin-top: 1rem; text-align: center; }
    .total-value .amount { font-size: 1.5rem; font-weight: 700; }
    @media (max-width: 900px) {
      .trade-setup { grid-template-columns: 1fr; }
      .analysis-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div id="app-header"></div>
  <script src="/layout.js"></script>
  <main class="app-main">
    <div class="container">
      <h1>üîÑ Trade Analyzer</h1>
      <p style="color: var(--text-muted); margin-bottom: 1.5rem;">Evaluate potential trades between wallets</p>
      
      <div class="trade-setup">
        <div class="trade-side left">
          <h3>üì§ You Give</h3>
          <input type="text" class="wallet-input" id="wallet1" placeholder="Search your wallet by name..." />
          <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
            <select id="filter-tier-1" class="wallet-input" style="flex: 1;" onchange="searchMoments(1)">
              <option value="">All tiers</option>
            </select>
            <select id="filter-series-1" class="wallet-input" style="flex: 1;" onchange="searchMoments(1)">
              <option value="">All series</option>
            </select>
          </div>
          <input type="text" class="wallet-input" id="search1" placeholder="Search moments to add..." oninput="searchMoments(1)"/>
          <div class="search-results" id="search-results-1"></div>
          <div class="trade-items" id="give-items"></div>
          <div class="total-value">
            <div class="amount" style="color: var(--accent1);" id="give-total">$0.00</div>
            <div style="font-size: 0.85rem; color: var(--text-muted);">Total Value</div>
          </div>
        </div>
        
        <div class="vs-section">
          <div class="vs-icon">‚öñÔ∏è</div>
          <button class="analyze-btn" onclick="analyzeTrade()">Analyze Trade</button>
        </div>
        
        <div class="trade-side right">
          <h3>üì• You Get</h3>
          <input type="text" class="wallet-input" id="wallet2" placeholder="Search their wallet by name..." />
          <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
            <select id="filter-tier-2" class="wallet-input" style="flex: 1;" onchange="searchMoments(2)">
              <option value="">All tiers</option>
            </select>
            <select id="filter-series-2" class="wallet-input" style="flex: 1;" onchange="searchMoments(2)">
              <option value="">All series</option>
            </select>
          </div>
          <input type="text" class="wallet-input" id="search2" placeholder="Search moments to add..." oninput="searchMoments(2)"/>
          <div class="search-results" id="search-results-2"></div>
          <div class="trade-items" id="get-items"></div>
          <div class="total-value">
            <div class="amount" style="color: var(--accent2);" id="get-total">$0.00</div>
            <div style="font-size: 0.85rem; color: var(--text-muted);">Total Value</div>
          </div>
        </div>
      </div>
      
      <div id="analysis-result"></div>
    </div>
  </main>
  <script src="/wallet-search.js"></script>
  <script>
    let wallet1Moments = [];
    let wallet2Moments = [];
    let giveItems = [];
    let getItems = [];

  function setFilterOptions(side, moments) {
    const tierSelect = document.getElementById(`filter-tier-${side}`);
    const seriesSelect = document.getElementById(`filter-series-${side}`);
    if (!tierSelect || !seriesSelect) return;

    const tiers = [...new Set(moments.map(m => (m.tier || "").trim()).filter(Boolean))]
      .sort((a, b) => a.localeCompare(b));
    const series = [...new Set(moments.map(m => (m.series_name || "").trim()).filter(Boolean))]
      .sort((a, b) => a.localeCompare(b));

    tierSelect.innerHTML = '<option value="">All tiers</option>' + tiers.map(t => `<option value="${t}">${t}</option>`).join('');
    seriesSelect.innerHTML = '<option value="">All series</option>' + series.map(s => `<option value="${s}">${s}</option>`).join('');
  }
    
    async function loadWallet1() {
      const input = document.getElementById('wallet1');
      // Use data attribute if available (from autocomplete), otherwise use input value
      const wallet = (input.dataset.walletAddress || input.value).trim().toLowerCase();
      if (!wallet || !wallet.startsWith('0x')) return;
      document.getElementById('search1').placeholder = 'Loading wallet...';
      try {
        const res = await fetch(`/api/query?wallet=${wallet}&source=database`);
        const data = await res.json();
        if (data.ok) {
          wallet1Moments = data.rows || [];
          document.getElementById('search1').placeholder = `Search ${wallet1Moments.length} moments to add...`;
      setFilterOptions(1, wallet1Moments);
        }
      } catch (e) { 
        console.error(e);
        document.getElementById('search1').placeholder = 'Error loading wallet';
      }
    }
    
    async function loadWallet2() {
      const input = document.getElementById('wallet2');
      // Use data attribute if available (from autocomplete), otherwise use input value
      const wallet = (input.dataset.walletAddress || input.value).trim().toLowerCase();
      if (!wallet || !wallet.startsWith('0x')) return;
      document.getElementById('search2').placeholder = 'Loading wallet...';
      try {
        const res = await fetch(`/api/query?wallet=${wallet}&source=database`);
        const data = await res.json();
        if (data.ok) {
          wallet2Moments = data.rows || [];
          document.getElementById('search2').placeholder = `Search ${wallet2Moments.length} moments to add...`;
      setFilterOptions(2, wallet2Moments);
        }
      } catch (e) { 
        console.error(e);
        document.getElementById('search2').placeholder = 'Error loading wallet';
      }
    }
    
    // Initialize wallet search with autocomplete (after functions are defined)
    initWalletSearch('wallet1', (wallet) => {
      loadWallet1();
    });
    initWalletSearch('wallet2', (wallet) => {
      loadWallet2();
    });
    
    function searchMoments(side) {
      const query = document.getElementById(`search${side}`).value.toLowerCase();
    const tierFilter = (document.getElementById(`filter-tier-${side}`)?.value || "").toLowerCase();
    const seriesFilter = (document.getElementById(`filter-series-${side}`)?.value || "").toLowerCase();
      const moments = side === 1 ? wallet1Moments : wallet2Moments;
      const items = side === 1 ? giveItems : getItems;
      const resultsDiv = document.getElementById(`search-results-${side}`);
      
      if (!query || query.length < 2) {
        resultsDiv.innerHTML = '';
        return;
      }
      
      // Filter moments and exclude already added ones
      const addedNftIds = new Set(items.map(i => i.nft_id));
    const matches = moments.filter(m => {
        if (addedNftIds.has(m.nft_id)) return false; // Already added
      if (tierFilter && (m.tier || "").toLowerCase() !== tierFilter) return false;
      if (seriesFilter && (m.series_name || "").toLowerCase() !== seriesFilter) return false;
      const name = `${m.first_name || ''} ${m.last_name || ''}`.toLowerCase();
      const team = (m.team_name || '').toLowerCase();
      const serial = (m.serial_number || '').toString();
      return name.includes(query) || team.includes(query) || serial.includes(query);
    }).slice(0, 50);
      
      resultsDiv.innerHTML = matches.map(m => `
        <div class="search-item" onclick="addItem(${side}, '${m.nft_id}')">
          <span style="font-weight: 600;">${m.first_name || ''} ${m.last_name || 'Unknown'}</span>
          <span style="color: var(--accent1); font-weight: 700;">#${m.serial_number || '?'}</span>
          <span style="color: var(--text-muted);">/ ${m.max_mint_size || '?'}</span>
          <span class="chip chip-${(m.tier || 'common').toLowerCase()}">${m.tier || ''}</span>
        </div>
      `).join('');
    }
    
    function addItem(side, nftId) {
      const moments = side === 1 ? wallet1Moments : wallet2Moments;
      const items = side === 1 ? giveItems : getItems;
      const moment = moments.find(m => m.nft_id === nftId);
      
      if (moment && !items.find(i => i.nft_id === nftId)) {
        items.push(moment);
        renderItems();
      }
      
      document.getElementById(`search${side}`).value = '';
      document.getElementById(`search-results-${side}`).innerHTML = '';
    }
    
    function removeItem(side, nftId) {
      if (side === 1) giveItems = giveItems.filter(i => i.nft_id !== nftId);
      else getItems = getItems.filter(i => i.nft_id !== nftId);
      renderItems();
    }
    
    async function renderItems() {
      const giveDiv = document.getElementById('give-items');
      const getDiv = document.getElementById('get-items');
      
      // Show loading state for totals
      document.getElementById('give-total').textContent = 'Loading...';
      document.getElementById('get-total').textContent = 'Loading...';
      
      // Fetch prices first
      const giveEditions = giveItems.map(m => m.edition_id).filter(Boolean);
      const getEditions = getItems.map(m => m.edition_id).filter(Boolean);
      const allEditions = [...new Set([...giveEditions, ...getEditions])];
      
      let priceMap = {};
      if (allEditions.length > 0) {
        try {
          const res = await fetch(`/api/prices?editions=${allEditions.join(',')}`);
          const data = await res.json();
          if (data.ok && data.lowAsk) priceMap = data.lowAsk;
        } catch (e) { console.error('Error fetching prices:', e); }
      }
      
      // Render give items with prices
      giveDiv.innerHTML = giveItems.length ? giveItems.map(m => {
        const price = m.edition_id && priceMap[m.edition_id] ? parseFloat(priceMap[m.edition_id]).toFixed(2) : '?';
        return `
          <div class="trade-item">
            <div class="info">
              <span>${m.first_name || ''} ${m.last_name || 'Unknown'}</span>
              <span style="color: var(--accent1); font-weight: 700; margin-left: 0.25rem;">#${m.serial_number || '?'}</span>
              <span class="chip chip-${(m.tier||'common').toLowerCase()}">${m.tier||''}</span>
            </div>
            <div style="display: flex; align-items: center; gap: 0.75rem;">
              <span class="value">$${price}</span>
              <span class="remove" onclick="removeItem(1, '${m.nft_id}')">√ó</span>
            </div>
          </div>
        `;
      }).join('') : '<div class="empty-trade">Search and add moments from your wallet</div>';
      
      // Render get items with prices
      getDiv.innerHTML = getItems.length ? getItems.map(m => {
        const price = m.edition_id && priceMap[m.edition_id] ? parseFloat(priceMap[m.edition_id]).toFixed(2) : '?';
        return `
          <div class="trade-item">
            <div class="info">
              <span>${m.first_name || ''} ${m.last_name || 'Unknown'}</span>
              <span style="color: var(--accent2); font-weight: 700; margin-left: 0.25rem;">#${m.serial_number || '?'}</span>
              <span class="chip chip-${(m.tier||'common').toLowerCase()}">${m.tier||''}</span>
            </div>
            <div style="display: flex; align-items: center; gap: 0.75rem;">
              <span class="value" style="color: var(--accent2);">$${price}</span>
              <span class="remove" onclick="removeItem(2, '${m.nft_id}')">√ó</span>
            </div>
          </div>
        `;
      }).join('') : '<div class="empty-trade">Search and add moments from their wallet</div>';
      
      // Calculate totals
      let giveTotal = 0, getTotal = 0;
      for (const m of giveItems) {
        if (m.edition_id && priceMap[m.edition_id]) giveTotal += parseFloat(priceMap[m.edition_id]) || 0;
      }
      for (const m of getItems) {
        if (m.edition_id && priceMap[m.edition_id]) getTotal += parseFloat(priceMap[m.edition_id]) || 0;
      }
      
      document.getElementById('give-total').textContent = '$' + giveTotal.toFixed(2);
      document.getElementById('get-total').textContent = '$' + getTotal.toFixed(2);
    }
    
    function analyzeTrade() {
      const giveTotal = parseFloat(document.getElementById('give-total').textContent.replace('$', '')) || 0;
      const getTotal = parseFloat(document.getElementById('get-total').textContent.replace('$', '')) || 0;
      
      if (giveItems.length === 0 || getItems.length === 0) {
        alert('Please add moments to both sides of the trade');
        return;
      }
      
      const diff = getTotal - giveTotal;
      const pctDiff = giveTotal > 0 ? (diff / giveTotal * 100) : 0;
      const isFair = Math.abs(pctDiff) <= 15;
      
      const giveTiers = { common: 0, uncommon: 0, rare: 0, legendary: 0, ultimate: 0 };
      const getTiers = { common: 0, uncommon: 0, rare: 0, legendary: 0, ultimate: 0 };
      
      giveItems.forEach(m => { if (m.tier) giveTiers[m.tier.toLowerCase()]++; });
      getItems.forEach(m => { if (m.tier) getTiers[m.tier.toLowerCase()]++; });
      
      document.getElementById('analysis-result').innerHTML = `
        <div class="analysis-result">
          <div class="analysis-header">
            <div class="analysis-verdict ${isFair ? 'fair' : 'unfair'}">
              ${isFair ? '‚úÖ Fair Trade' : (diff > 0 ? 'üéâ Great Deal!' : '‚ö†Ô∏è Bad Deal')}
            </div>
            <div style="color: var(--text-muted);">
              ${diff > 0 ? 'You gain' : 'You lose'} $${Math.abs(diff).toFixed(2)} (${Math.abs(pctDiff).toFixed(1)}%)
            </div>
          </div>
          
          <div class="analysis-grid">
            <div class="analysis-stat">
              <div class="value" style="color: var(--accent1);">$${giveTotal.toFixed(2)}</div>
              <div class="label">You Give (${giveItems.length} moments)</div>
            </div>
            <div class="analysis-stat">
              <div class="value">${diff >= 0 ? '+' : ''}$${diff.toFixed(2)}</div>
              <div class="label">Net Difference</div>
            </div>
            <div class="analysis-stat">
              <div class="value" style="color: var(--accent2);">$${getTotal.toFixed(2)}</div>
              <div class="label">You Get (${getItems.length} moments)</div>
            </div>
          </div>
          
          <div style="margin-top: 1.5rem; display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div>
              <strong style="color: var(--accent1);">Giving Tiers:</strong>
              <div style="margin-top: 0.5rem; font-size: 0.9rem; color: var(--text-muted);">
                ${Object.entries(giveTiers).filter(([k,v]) => v > 0).map(([k,v]) => `${v} ${k}`).join(', ') || 'None'}
              </div>
            </div>
            <div>
              <strong style="color: var(--accent2);">Getting Tiers:</strong>
              <div style="margin-top: 0.5rem; font-size: 0.9rem; color: var(--text-muted);">
                ${Object.entries(getTiers).filter(([k,v]) => v > 0).map(([k,v]) => `${v} ${k}`).join(', ') || 'None'}
              </div>
            </div>
          </div>
        </div>
      `;
    }
    
    renderItems();
  </script>
</body>
</html>

