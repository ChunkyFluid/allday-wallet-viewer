<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Moment Sniper | NFL All Day</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="header.css" />
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet" />
  <style>
    :root {
      --sniper-bg: #050815;
      --sniper-card: #0b1020;
      --sniper-border: #1b2236;
      --deal-hot: #ef4444;
      --deal-warm: #f97316;
      --deal-good: #22c55e;
      --deal-neutral: #6b7280;
      --gold: #fbbf24;
      --text: #f8f9ff;
      --text-muted: #8c95b8;
    }

    body {
      background: radial-gradient(circle at top, #101526 0, #050815 55%);
      min-height: 100vh;
      font-family: 'Outfit', sans-serif;
      color: var(--text);
      margin: 0;
    }

    .sniper-container {
      max-width: 1800px;
      margin: 0 auto;
      padding: 1.5rem;
    }

    /* Page Header - Title left, Stats right */
    .page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 24px;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }

    .page-header-left {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .page-header h1 {
      font-size: 1.5rem;
      font-weight: 700;
      background: linear-gradient(135deg, #ff5b81, #ffb64d, #6f42c1, #00d4ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .page-header h1::before {
      content: "üéØ";
      -webkit-text-fill-color: initial;
    }

    .page-subtitle {
      color: var(--text-muted);
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .live-dot {
      width: 8px;
      height: 8px;
      background: #22c55e;
      border-radius: 50%;
      animation: blink 2s infinite;
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    /* Stats Bar - right side of header */
    .stats-bar {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .stat-card {
      background: var(--sniper-card);
      border: 1px solid var(--sniper-border);
      border-radius: 12px;
      padding: 12px 20px;
      text-align: center;
      min-width: 100px;
    }

    .stat-card .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      font-family: 'JetBrains Mono', monospace;
    }

    .stat-card .stat-label {
      font-size: 0.65rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 2px;
    }

    .stat-card.deals .stat-value { color: #22c55e; }
    .stat-card.listings .stat-value { color: #3b82f6; }

    /* Two Column Layout */
    .layout-two-column {
      display: grid;
      grid-template-columns: 260px minmax(0, 1fr);
      gap: 1.5rem;
      align-items: flex-start;
    }

    /* Filters Sidebar */
    .filters-card {
      background: radial-gradient(circle at top left, #171d34 0, #050915 55%);
      border-radius: 16px;
      border: 1px solid var(--sniper-border);
      padding: 1.2rem;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.5);
      position: sticky;
      top: 1rem;
    }

    .filters-title {
      font-size: 0.95rem;
      font-weight: 600;
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .filters-title .cache-info {
      font-size: 0.7rem;
      color: var(--text-muted);
      font-weight: 400;
    }

    .filter-group {
      margin-bottom: 0.75rem;
    }

    .filter-label {
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 0.25rem;
      color: var(--text-muted);
      display: block;
    }

    .filter-select,
    .filter-input {
      width: 100%;
      background: #050a18;
      border-radius: 10px;
      border: 1px solid var(--sniper-border);
      padding: 0.5rem 0.65rem;
      color: var(--text);
      font-size: 0.85rem;
      outline: none;
      font-family: 'Outfit', sans-serif;
    }

    .filter-select:focus,
    .filter-input:focus {
      border-color: #6f42c1;
    }

    .filters-actions {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid var(--sniper-border);
    }

    .btn-refresh {
      background: linear-gradient(135deg, #6f42c1, #007bff);
      color: white;
      border: none;
      padding: 0.6rem 1rem;
      border-radius: 999px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      font-size: 0.85rem;
      transition: transform 0.15s, box-shadow 0.15s;
      width: 100%;
    }

    .btn-refresh:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(111, 66, 193, 0.4);
    }

    .btn-refresh.loading {
      opacity: 0.7;
      pointer-events: none;
    }

    .btn-refresh.loading .refresh-icon {
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .auto-refresh-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .auto-refresh-row label {
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }

    .countdown {
      font-family: 'JetBrains Mono', monospace;
      color: #22c55e;
      font-size: 0.75rem;
    }

    /* Results Card */
    .results-card {
      background: #050915;
      border-radius: 16px;
      border: 1px solid var(--sniper-border);
      overflow: hidden;
    }

    .results-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--sniper-border);
      background: rgba(15, 23, 42, 0.5);
    }

    .results-info {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .view-toggle {
      display: flex;
      gap: 4px;
      background: #1f2937;
      border-radius: 8px;
      padding: 3px;
    }

    .view-toggle button {
      background: transparent;
      border: none;
      color: var(--text-muted);
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.15s;
    }

    .view-toggle button.active {
      background: #374151;
      color: var(--text);
    }

    /* Listings Grid */
    .listings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 16px;
    }

    .listing-card {
      background: var(--sniper-card);
      border: 1px solid var(--sniper-border);
      border-radius: 12px;
      overflow: hidden;
      transition: transform 0.2s, box-shadow 0.2s;
      position: relative;
    }

    .listing-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
    }

    .listing-card.hot-deal {
      border-color: var(--deal-hot);
      box-shadow: 0 0 20px rgba(239, 68, 68, 0.2);
    }

    .listing-card.good-deal {
      border-color: var(--deal-good);
    }

    /* Deal Badge */
    .deal-badge {
      position: absolute;
      top: 12px;
      right: 12px;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 700;
      font-family: 'JetBrains Mono', monospace;
      z-index: 10;
    }

    .deal-badge.hot {
      background: var(--deal-hot);
      color: white;
      animation: pulse 2s ease-in-out infinite;
    }

    .deal-badge.warm {
      background: var(--deal-warm);
      color: white;
    }

    .deal-badge.good {
      background: var(--deal-good);
      color: white;
    }

    .deal-badge.neutral {
      background: var(--deal-neutral);
      color: white;
    }

    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
      50% { box-shadow: 0 0 0 8px rgba(239, 68, 68, 0); }
    }

    /* Card Content */
    .card-image {
      height: 180px;
      background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }

    .card-image img {
      max-height: 100%;
      max-width: 100%;
      object-fit: contain;
    }

    .card-image .tier-badge {
      position: absolute;
      bottom: 8px;
      left: 8px;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.65rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .tier-badge.legendary { background: linear-gradient(135deg, #fbbf24, #d97706); color: #1f2937; }
    .tier-badge.rare { background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; }
    .tier-badge.uncommon { background: linear-gradient(135deg, #10b981, #059669); color: white; }
    .tier-badge.common { background: #4b5563; color: white; }

    .card-body {
      padding: 16px;
    }

    .player-name {
      font-size: 1.1rem;
      font-weight: 700;
      color: #f3f4f6;
      margin: 0 0 4px 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .play-info {
      font-size: 0.8rem;
      color: #9ca3af;
      margin: 0 0 12px 0;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .play-info span {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    /* Price Section */
    .price-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--sniper-border);
    }

    .price-box {
      text-align: center;
    }

    .price-box .price-label {
      font-size: 0.65rem;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }

    .price-box .price-value {
      font-size: 1.25rem;
      font-weight: 700;
      font-family: 'JetBrains Mono', monospace;
    }

    .price-box.listing .price-value {
      color: #3b82f6;
    }

    .price-box.floor .price-value {
      color: #9ca3af;
    }

    /* Serial Badge */
    .serial-badge {
      position: absolute;
      top: 12px;
      left: 12px;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
      padding: 4px 8px;
      border-radius: 4px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.75rem;
      font-weight: 600;
      color: #e5e7eb;
    }

    .serial-badge.low-serial {
      background: linear-gradient(135deg, var(--gold), #d97706);
      color: #1f2937;
    }

    /* Action Button */
    .btn-snipe {
      display: block;
      width: 100%;
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
      border: none;
      padding: 12px;
      font-size: 0.9rem;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.15s, box-shadow 0.15s;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .btn-snipe:hover {
      transform: scale(1.02);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
    }

    /* Time Badge */
    .time-badge {
      font-size: 0.7rem;
      color: #6b7280;
      display: flex;
      align-items: center;
      gap: 4px;
      margin-top: 8px;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #6b7280;
    }

    .empty-state .icon {
      font-size: 4rem;
      margin-bottom: 16px;
    }

    .empty-state h3 {
      font-size: 1.25rem;
      color: #9ca3af;
      margin: 0 0 8px 0;
    }

    .empty-state p {
      margin: 0;
    }

    /* Status */
    #status {
      text-align: center;
      padding: 12px;
      color: #9ca3af;
      font-size: 0.875rem;
    }

    #status.error { color: var(--deal-hot); }
    #status.success { color: var(--deal-good); }

    /* Loading skeleton */
    .skeleton {
      background: linear-gradient(90deg, #1f2937 25%, #374151 50%, #1f2937 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: 4px;
    }

    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    /* View toggle */
    .view-toggle {
      display: flex;
      gap: 4px;
      background: #1f2937;
      border-radius: 8px;
      padding: 4px;
    }

    .view-toggle button {
      background: transparent;
      border: none;
      color: #6b7280;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.875rem;
      transition: all 0.15s;
    }

    .view-toggle button.active {
      background: #374151;
      color: #f3f4f6;
    }

    /* Table View */
    .listings-table {
      width: 100%;
      border-collapse: collapse;
      display: none;
    }

    .listings-table.active {
      display: table;
    }

    .listings-grid.active {
      display: grid;
    }

    .listings-grid:not(.active) {
      display: none;
    }

    .listings-table th,
    .listings-table td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid var(--sniper-border);
    }

    .listings-table th:last-child,
    .listings-table td:last-child {
      white-space: nowrap;
      min-width: 100px;
    }

    .listing-sold {
      opacity: 0.6;
    }

    .listing-sold td {
      color: #6b7280 !important;
    }

    .listing-unlisted {
      opacity: 0.5;
    }

    .listing-unlisted td {
      color: #9ca3af !important;
    }

    .listings-table th {
      background: var(--sniper-card);
      color: #9ca3af;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
      cursor: pointer;
      user-select: none;
    }

    .listings-table th:hover {
      color: #e5e7eb;
    }

    .listings-table th.sorted-asc::after { content: " ‚ñ≤"; }
    .listings-table th.sorted-desc::after { content: " ‚ñº"; }

    .listings-table tr {
      background: var(--sniper-card);
      transition: background 0.15s;
    }

    .listings-table tr:hover {
      background: #1f2937;
    }

    .listings-table .deal-cell {
      font-family: 'JetBrains Mono', monospace;
      font-weight: 600;
    }

    .listings-table .deal-cell.hot { color: var(--deal-hot); }
    .listings-table .deal-cell.warm { color: var(--deal-warm); }
    .listings-table .deal-cell.good { color: var(--deal-good); }
    .listings-table .deal-cell.neutral { color: var(--deal-neutral); }

    .listings-table th {
      background: rgba(15, 23, 42, 0.8);
      position: sticky;
      top: 0;
    }

    .listings-table tr {
      background: transparent;
    }

    .listings-table tr:nth-child(even) {
      background: rgba(255, 255, 255, 0.02);
    }

    .listings-table tr:hover {
      background: rgba(111, 66, 193, 0.1);
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 3rem;
      color: var(--text-muted);
    }

    .empty-state .icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }

    /* Mobile filter toggle button */
    .filters-toggle {
      display: none;
      width: 100%;
      background: var(--sniper-card);
      border: 1px solid var(--sniper-border);
      border-radius: 12px;
      padding: 1rem;
      color: var(--text);
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      margin-bottom: 1rem;
      align-items: center;
      justify-content: space-between;
    }

    .filters-toggle .toggle-icon {
      transition: transform 0.2s;
    }

    .filters-toggle.open .toggle-icon {
      transform: rotate(180deg);
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .layout-two-column {
        grid-template-columns: 1fr;
      }
      .filters-card {
        position: static;
      }
      .page-header {
        flex-direction: column;
        align-items: flex-start;
      }
      .stats-bar {
        width: 100%;
        justify-content: flex-start;
      }
    }

    @media (max-width: 768px) {
      .sniper-container {
        padding: 1rem 0.75rem;
      }
      
      .page-header h1 { font-size: 1.1rem; }
      
      .page-header-left {
        width: 100%;
      }
      
      .stats-bar {
        gap: 8px;
      }
      
      .stat-card { 
        min-width: 70px; 
        padding: 8px 12px;
        flex: 1;
      }
      .stat-card .stat-value { font-size: 1.1rem; }
      .stat-card .stat-label { font-size: 0.6rem; }
      
      /* Show filter toggle on mobile */
      .filters-toggle {
        display: flex;
      }
      
      /* Hide filters by default on mobile */
      .filters-card {
        display: none;
        margin-bottom: 1rem;
      }
      
      .filters-card.open {
        display: block;
      }
      
      .layout-two-column {
        gap: 0;
      }
      
      /* Table improvements */
      .results-card {
        border-radius: 12px;
      }
      
      .results-header {
        padding: 0.75rem 1rem;
        flex-direction: column;
        gap: 0.75rem;
        align-items: stretch;
      }
      
      .results-info {
        font-size: 0.8rem;
        text-align: center;
      }
      
      .view-toggle {
        justify-content: center;
      }
      
      /* Make table scrollable horizontally */
      .listings-table {
        display: block;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      
      .listings-table thead,
      .listings-table tbody,
      .listings-table tr {
        display: table;
        width: 100%;
        table-layout: fixed;
      }
      
      .listings-table {
        min-width: 800px;
      }
      
      .listings-table th,
      .listings-table td {
        padding: 10px 8px;
        font-size: 0.75rem;
      }
      
      .listings-grid { 
        grid-template-columns: 1fr;
        padding: 1rem;
        gap: 12px;
      }
      
      .listing-card {
        border-radius: 10px;
      }
      
      .card-image {
        height: 140px;
      }
      
      .card-body {
        padding: 12px;
      }
      
      .player-name {
        font-size: 1rem;
      }
      
      .btn-snipe {
        padding: 14px;
        font-size: 0.85rem;
      }
    }

    @media (max-width: 480px) {
      .sniper-container {
        padding: 0.75rem 0.5rem;
      }
      
      .page-header h1 { font-size: 1rem; }
      
      .stat-card { 
        padding: 6px 10px;
      }
      .stat-card .stat-value { font-size: 1rem; }
      
      .listings-table th,
      .listings-table td {
        padding: 8px 6px;
        font-size: 0.7rem;
      }
    }

    /* ========== MOBILE CARD LIST ========== */
    .mobile-listings {
      display: none;
    }

    @media (max-width: 768px) {
      .listings-table {
        display: none !important;
      }
      
      .mobile-listings {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      
      .mobile-card {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: linear-gradient(135deg, rgba(15, 23, 42, 0.9), rgba(30, 41, 59, 0.6));
        border: 1px solid var(--sniper-border);
        border-radius: 12px;
        text-decoration: none;
        color: inherit;
        transition: transform 0.15s, border-color 0.15s;
      }
      
      .mobile-card:hover {
        transform: translateX(4px);
        border-color: #3b82f6;
      }
      
      .mobile-card.is-deal {
        border-left: 3px solid #22c55e;
      }
      
      .mobile-card.is-hot-deal {
        border-left: 3px solid #22c55e;
        background: linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(15, 23, 42, 0.9));
      }
      
      .mobile-card-icon {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        flex-shrink: 0;
      }
      
      .mobile-card-icon.common { background: #4b5563; }
      .mobile-card-icon.uncommon { background: #6b7280; }
      .mobile-card-icon.rare { background: #f97316; }
      .mobile-card-icon.legendary { background: linear-gradient(135deg, #ffd54f, #ffb300); }
      .mobile-card-icon.ultimate { background: linear-gradient(135deg, #ff5b81, #6f42c1); }
      
      .mobile-card-main {
        flex: 1;
        min-width: 0;
      }
      
      .mobile-card-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 2px;
      }
      
      .mobile-card-player {
        font-weight: 600;
        font-size: 0.95rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      
      .mobile-card-team {
        font-size: 0.65rem;
        font-weight: 600;
        padding: 2px 6px;
        border-radius: 4px;
        background: rgba(255, 255, 255, 0.1);
        color: var(--text-muted);
        flex-shrink: 0;
      }
      
      .mobile-card-tier {
        font-size: 0.6rem;
        font-weight: 600;
        padding: 2px 6px;
        border-radius: 4px;
        text-transform: uppercase;
        flex-shrink: 0;
      }
      
      .mobile-card-tier.common { background: #4b5563; color: #e5e7eb; }
      .mobile-card-tier.uncommon { background: #6b7280; color: #e5e7eb; }
      .mobile-card-tier.rare { background: #f97316; color: #111; }
      .mobile-card-tier.legendary { background: linear-gradient(135deg, #ffd54f, #ffb300); color: #111; }
      .mobile-card-tier.ultimate { background: linear-gradient(135deg, #ff5b81, #6f42c1); color: #fff; }
      
      .mobile-card-details {
        font-size: 0.75rem;
        color: var(--text-muted);
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
      }
      
      .mobile-card-set {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 150px;
      }
      
      .mobile-card-right {
        text-align: right;
        flex-shrink: 0;
      }
      
      .mobile-card-price {
        font-family: 'JetBrains Mono', monospace;
        font-size: 1rem;
        font-weight: 700;
        color: #3b82f6;
      }
      
      .mobile-card.is-deal .mobile-card-price,
      .mobile-card.is-hot-deal .mobile-card-price {
        color: #22c55e;
      }
      
      .mobile-card-deal {
        font-size: 0.7rem;
        font-weight: 600;
      }
      
      .mobile-card-deal.positive { color: #22c55e; }
      .mobile-card-deal.negative { color: #ef4444; }
      .mobile-card-deal.neutral { color: #6b7280; }
      
      .mobile-card-serial {
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.7rem;
        color: var(--text-muted);
      }
      
      .mobile-card-serial.low-serial {
        color: #fbbf24;
        font-weight: 600;
      }
      
      .view-toggle {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div id="app-header"></div>
  
  <div class="sniper-container">
    <!-- Page Header: Title left, Stats right -->
    <div class="page-header">
      <div class="page-header-left">
        <h1>Moment Sniper</h1>
        <div class="page-subtitle">
          <span class="live-dot" id="live-dot"></span>
          <span id="live-status">Connecting...</span>
        </div>
      </div>
      
      <div class="stats-bar">
        <div class="stat-card deals">
          <div class="stat-value" id="stat-deals">0</div>
          <div class="stat-label">üî• Deals</div>
        </div>
        <div class="stat-card listings">
          <div class="stat-value" id="stat-listings">0</div>
          <div class="stat-label">Total</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-filtered" style="color: #9ca3af;">0</div>
          <div class="stat-label">Showing</div>
        </div>
      </div>
    </div>

    <!-- Mobile Filter Toggle -->
    <button class="filters-toggle" id="filters-toggle">
      <span>üéöÔ∏è Filters</span>
      <span class="toggle-icon">‚ñº</span>
    </button>

    <!-- Two Column Layout -->
    <div class="layout-two-column">
      <!-- Left: Filters -->
      <aside class="filters-card" id="filters-card">
        <div class="filters-title">
          Filters
          <span class="cache-info" id="cache-status">0 floors</span>
        </div>

        <div class="filter-group">
          <label class="filter-label">Sort By</label>
          <select class="filter-select" id="sort-by">
            <option value="time-desc">Most Recent</option>
            <option value="deal-desc">Best Deals First</option>
            <option value="price-asc">Price: Low to High</option>
            <option value="price-desc">Price: High to Low</option>
            <option value="serial-asc">Serial: Low to High</option>
          </select>
        </div>

        <div class="filter-group">
          <label class="filter-label">Show</label>
          <select class="filter-select" id="filter-deals-only">
            <option value="">All Listings</option>
            <option value="deals">Deals Only</option>
          </select>
        </div>

        <div class="filter-group">
          <label class="filter-label">Status</label>
          <select class="filter-select" id="filter-status">
            <option value="active">Active Only</option>
            <option value="all">All (Including Sold/Delisted)</option>
            <option value="sold">Sold Only</option>
            <option value="unlisted">Delisted Only</option>
            <option value="sold-unlisted">Sold & Delisted</option>
          </select>
        </div>

        <div class="filter-group">
          <label class="filter-label">Min Discount</label>
          <select class="filter-select" id="filter-min-discount">
            <option value="">Any</option>
            <option value="5">5%+ off</option>
            <option value="10">10%+ off</option>
            <option value="15">15%+ off</option>
            <option value="20">20%+ off</option>
            <option value="30">30%+ off</option>
            <option value="35">35%+ off</option>
            <option value="40">40%+ off</option>
            <option value="45">45%+ off</option>
            <option value="50">50%+ off</option>
            <option value="55">55%+ off</option>
          </select>
        </div>

        <div class="filter-group">
          <label class="filter-label">Owned Status</label>
          <select class="filter-select" id="filter-owned">
            <option value="">All</option>
            <option value="owned">Owned</option>
            <option value="not-owned">Not Owned</option>
          </select>
        </div>

        <div class="filter-group">
          <label class="filter-label">Tier</label>
          <select class="filter-select" id="filter-tier">
            <option value="">All Tiers</option>
            <option value="ULTIMATE">Ultimate</option>
            <option value="LEGENDARY">Legendary</option>
            <option value="RARE">Rare</option>
            <option value="UNCOMMON">Uncommon</option>
            <option value="COMMON">Common</option>
          </select>
        </div>

        <div class="filter-group">
          <label class="filter-label">Max Price</label>
          <input type="number" class="filter-input" id="filter-max-price" placeholder="Any" min="0" />
        </div>

        <div class="filter-group">
          <label class="filter-label">Max Serial</label>
          <input type="number" class="filter-input" id="filter-max-serial" placeholder="Any" min="1" />
        </div>

        <div class="filter-group">
          <label class="filter-label">Player</label>
          <input type="text" class="filter-input" id="filter-player" placeholder="Search..." />
        </div>

        <div class="filter-group">
          <label class="filter-label">Team</label>
          <select class="filter-select" id="filter-team">
            <option value="">All Teams</option>
          </select>
        </div>

        <div class="filter-group">
          <label class="filter-label">Marketplace</label>
          <select class="filter-select" id="filter-marketplace">
            <option value="all">All Marketplaces</option>
            <option value="nflad">NFL AllDay Only</option>
            <option value="flowty">Flowty Only</option>
          </select>
        </div>

        <div class="filters-actions">
          <button class="btn-refresh" id="btn-refresh">
            <span class="refresh-icon">‚Üª</span>
            Refresh
          </button>
          <div class="auto-refresh-row">
            <label>
              <input type="checkbox" id="auto-refresh" checked />
              Auto-refresh
            </label>
            <span class="countdown" id="countdown">3s</span>
          </div>
        </div>
      </aside>

      <!-- Right: Results -->
      <div class="results-card">
        <div class="results-header">
          <div class="results-info" id="status">Loading marketplace data...</div>
          <div class="view-toggle">
            <button id="view-grid" title="Grid View">‚ñ¶</button>
            <button id="view-table" class="active" title="Table View">‚ò∞</button>
          </div>
        </div>

        <!-- Grid View -->
        <div class="listings-grid" id="listings-grid"></div>

        <!-- Table View (Desktop) -->
        <table class="listings-table active" id="listings-table">
          <thead>
            <tr>
              <th data-sort="player">Player</th>
              <th>Owned</th>
              <th data-sort="tier">Tier</th>
              <th data-sort="serial">Serial</th>
              <th data-sort="price">Listed</th>
              <th data-sort="floor">Floor</th>
              <th data-sort="asp">ASP</th>
              <th data-sort="deal">vs Floor</th>
              <th>Series</th>
              <th>Set</th>
              <th>Seller</th>
              <th>Buyer</th>
              <th data-sort="time">When</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="table-body"></tbody>
        </table>

        <!-- Mobile Card View -->
        <div class="mobile-listings" id="mobile-listings"></div>
        
        <!-- Pagination -->
        <div id="sniper-pager" style="margin-top: 1rem; display: flex; gap: 0.5rem; align-items: center; justify-content: center; font-size: 0.85rem;">
          <button id="sniper-page-prev" style="padding: 0.5rem 1rem; background: rgba(111, 66, 193, 0.2); border: 1px solid rgba(111, 66, 193, 0.4); border-radius: 6px; color: #e5e7eb; cursor: pointer;" disabled>‚Üê Prev</button>
          <span id="sniper-page-info" style="color: #9ca3af; min-width: 200px; text-align: center;"></span>
          <button id="sniper-page-next" style="padding: 0.5rem 1rem; background: rgba(111, 66, 193, 0.2); border: 1px solid rgba(111, 66, 193, 0.4); border-radius: 6px; color: #e5e7eb; cursor: pointer;" disabled>Next ‚Üí</button>
        </div>
      </div>
    </div>
  </div>

  <script src="layout.js"></script>
  <script>
    // NFL Teams for filter
    const NFL_TEAMS = [
      "Arizona Cardinals", "Atlanta Falcons", "Baltimore Ravens", "Buffalo Bills",
      "Carolina Panthers", "Chicago Bears", "Cincinnati Bengals", "Cleveland Browns",
      "Dallas Cowboys", "Denver Broncos", "Detroit Lions", "Green Bay Packers",
      "Houston Texans", "Indianapolis Colts", "Jacksonville Jaguars", "Kansas City Chiefs",
      "Las Vegas Raiders", "Los Angeles Chargers", "Los Angeles Rams", "Miami Dolphins",
      "Minnesota Vikings", "New England Patriots", "New Orleans Saints", "New York Giants",
      "New York Jets", "Philadelphia Eagles", "Pittsburgh Steelers", "San Francisco 49ers",
      "Seattle Seahawks", "Tampa Bay Buccaneers", "Tennessee Titans", "Washington Commanders"
    ];

    // State
    let listings = [];
    let autoRefreshInterval = null;
    let countdownValue = 5;
    let currentView = 'table'; // Default to table/list view
    let ownedCounts = {}; // Map of edition_id -> count for signed-in user
    let userWallet = null; // User's wallet address if signed in
    let isInitialLoad = true; // Track if this is the first load
    let isLoadingListings = false; // Track if listings are currently being fetched
    let currentPage = 1; // Current page number
    const PAGE_SIZE = 20; // Listings per page
    let pendingRefresh = false; // Track if a refresh is queued

    // Elements
    const listingsGrid = document.getElementById('listings-grid');
    const listingsTable = document.getElementById('listings-table');
    const tableBody = document.getElementById('table-body');
    const statusEl = document.getElementById('status');
    const btnRefresh = document.getElementById('btn-refresh');
    const autoRefreshCheckbox = document.getElementById('auto-refresh');
    const countdownEl = document.getElementById('countdown');

    // Filters
    const filterDealsOnly = document.getElementById('filter-deals-only');
    const filterMinDiscount = document.getElementById('filter-min-discount');
    const filterOwned = document.getElementById('filter-owned');
    const filterTier = document.getElementById('filter-tier');
    const filterMaxPrice = document.getElementById('filter-max-price');
    const filterMaxSerial = document.getElementById('filter-max-serial');
    const filterPlayer = document.getElementById('filter-player');
    const filterTeam = document.getElementById('filter-team');
    const filterMarketplace = document.getElementById('filter-marketplace');
    const filterStatus = document.getElementById('filter-status');
    const sortBy = document.getElementById('sort-by');

    // View toggle
    document.getElementById('view-grid').addEventListener('click', () => {
      currentView = 'grid';
      document.getElementById('view-grid').classList.add('active');
      document.getElementById('view-table').classList.remove('active');
      listingsGrid.classList.add('active');
      listingsTable.classList.remove('active');
    });

    document.getElementById('view-table').addEventListener('click', () => {
      currentView = 'table';
      document.getElementById('view-table').classList.add('active');
      document.getElementById('view-grid').classList.remove('active');
      listingsTable.classList.add('active');
      listingsGrid.classList.remove('active');
    });

    // Format helpers
    function formatPrice(val) {
      if (val == null) return '-';
      return '$' + Number(val).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function formatDealPercent(listing, floor) {
      if (!floor || !listing || floor <= 0) return null;
      const diff = ((floor - listing) / floor) * 100;
      return diff;
    }

    function getDealClass(percent) {
      if (percent == null) return 'neutral';
      if (percent >= 20) return 'hot';
      if (percent >= 10) return 'warm';
      if (percent >= 5) return 'good';
      return 'neutral';
    }

    function formatTimeAgo(date) {
      if (!date) return '-';
      const now = new Date();
      const diff = now - new Date(date);
      const mins = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);
      
      if (mins < 1) return 'Just now';
      if (mins < 60) return `${mins}m ago`;
      if (hours < 24) return `${hours}h ago`;
      return `${days}d ago`;
    }

    function getTierClass(tier) {
      if (!tier) return 'common';
      return tier.toLowerCase();
    }

    // Fetch user's owned moments if signed in
    async function fetchOwnedCounts() {
      try {
        // Check if user is signed in
        const meRes = await fetch('/api/me', { credentials: 'include' });
        const meData = await meRes.json();
        
        if (!meData.ok || !meData.user || !meData.user.default_wallet_address) {
          ownedCounts = {};
          userWallet = null;
          return;
        }
        
        userWallet = meData.user.default_wallet_address;
        
        // Fetch wallet moments
        const walletRes = await fetch(`/api/query?wallet=${encodeURIComponent(userWallet)}`);
        const walletData = await walletRes.json();
        
        if (!walletData.ok || !walletData.rows) {
          ownedCounts = {};
          return;
        }
        
        // Count duplicates by edition_id
        const counts = {};
        for (const moment of walletData.rows) {
          if (moment.edition_id) {
            counts[moment.edition_id] = (counts[moment.edition_id] || 0) + 1;
          }
        }
        
        ownedCounts = counts;
      } catch (err) {
        console.error('Error fetching owned counts:', err);
        ownedCounts = {};
        userWallet = null;
      }
    }
    
    // Get owned count for a listing
    function getOwnedCount(editionId) {
      if (!editionId || !ownedCounts[editionId]) return null;
      return ownedCounts[editionId];
    }
    
    // Warmup the cache on first load
    let cacheWarmedUp = false;
    let availableTeams = [];
    
    async function warmupCache() {
      if (cacheWarmedUp) return;
      try {
        document.getElementById('live-status').textContent = 'Warming up cache...';
        const res = await fetch('/api/sniper-warmup?limit=100');
        const data = await res.json();
        if (data.ok) {
          document.getElementById('cache-status').textContent = `${data.cacheSize} floors cached`;
          cacheWarmedUp = true;
        }
      } catch (e) {
        console.error('Warmup error:', e);
      }
    }
    
    // Fetch all listings
    async function fetchListings() {
      if (isLoadingListings) {
        console.log('[Sniper] Already loading, skipping...');
        pendingRefresh = true;
        return;
      }
      
      btnRefresh.classList.add('loading');
      isLoadingListings = true;
      pendingRefresh = false;
      
      if (statusEl) {
        statusEl.textContent = 'Loading listings...';
        statusEl.className = '';
      }
      // Show loading state in table
      renderListings();

      try {
        // Fetch owned counts if user is signed in (do this in parallel with listings)
        const ownedPromise = fetchOwnedCounts();
        
        // Always use real-time endpoint - it's fast and reads from in-memory array
        // The watcher continuously populates the array, so it should have recent listings
        let data;
        let isHistoricalData = false;
        
        if (isInitialLoad) {
          console.log('[Sniper] Initial load - fetching real-time listings...');
          isInitialLoad = false; // Mark as no longer initial load
        }
        
        // Use real-time endpoint (fast - reads from in-memory array)
        // Add timeout to prevent hanging
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 20000); // 20 second timeout (increased for slow connections)
        
        try {
          // Build query params including marketplace and status filters
          const params = new URLSearchParams();
          if (filterMarketplace.value && filterMarketplace.value !== 'all') {
            params.append('marketplace', filterMarketplace.value);
          }
          if (filterStatus.value && filterStatus.value !== 'active') {
            params.append('status', filterStatus.value);
          }
          
          const response = await fetch(`/api/sniper-deals?${params.toString()}`, { signal: controller.signal });
          clearTimeout(timeoutId);
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          
          data = await response.json();
          console.log('[Sniper] Real-time response:', { ok: data.ok, count: data.listings?.length || 0, watching: data.watching });
          
          // If no listings yet and watcher just started, show a message
          if (data.listings && data.listings.length === 0 && !data.watching) {
            console.log('[Sniper] No listings yet - watcher may still be starting');
          }
        } catch (fetchErr) {
          clearTimeout(timeoutId);
          if (fetchErr.name === 'AbortError') {
            throw new Error('Request timed out - server may be slow. Please try refreshing.');
          }
          throw fetchErr;
        }

        // Validate response
        if (!data) {
          console.error('[Sniper] No data received from API');
          throw new Error('No data received from API');
        }

        if (!data.ok) {
          console.error('[Sniper] API returned not ok:', data.error);
          throw new Error(data.error || 'Failed to fetch listings');
        }

        if (data.error) {
          console.error('[Sniper] API returned error:', data.error);
          throw new Error(data.error);
        }

        listings = data.listings || [];
        
        if (!Array.isArray(listings)) {
          console.error('[Sniper] listings is not an array!', typeof listings, listings);
          listings = [];
        }
        
        console.log('[Sniper] Final listings count:', listings.length);
        
        console.log('[Sniper] Processed listings:', listings.length, 'isHistorical:', isHistoricalData);
        
        // Normalize listing structure if coming from historical endpoint
        // (sniper-listings uses currentFloor, sniper-deals uses floor)
        if (isHistoricalData && listings.length > 0) {
          listings = listings.map(l => {
            const normalized = { ...l };
            if (l.currentFloor !== undefined && l.floor === undefined) {
              normalized.floor = l.currentFloor;
            }
            return normalized;
          });
          console.log('[Sniper] Normalized historical listings:', listings.length);
        }
        
        // Ensure we have listings array even if empty
        if (!Array.isArray(listings)) {
          console.error('[Sniper] listings is not an array:', typeof listings, listings);
          listings = [];
        }
        
        // Wait for owned counts to finish
        await ownedPromise;
        
        // Update stats
        const dealsCount = listings.filter(l => l.dealPercent && l.dealPercent > 0).length;
        document.getElementById('stat-deals').textContent = dealsCount || 0;
        document.getElementById('stat-listings').textContent = listings.length || 0;
        
        // Populate team dropdown from API data (only if available)
        if (data.availableTeams && data.availableTeams.length > 0) {
          availableTeams = data.availableTeams;
          const currentTeam = filterTeam.value;
          filterTeam.innerHTML = '<option value="">All Teams</option>';
          availableTeams.forEach(team => {
            const opt = document.createElement('option');
            opt.value = team;
            opt.textContent = team;
            filterTeam.appendChild(opt);
          });
          filterTeam.value = currentTeam; // Restore selection
        } else if (listings.length > 0) {
          // If no teams from API, extract from listings
          const uniqueTeams = [...new Set(listings.map(l => l.teamName).filter(Boolean))].sort();
          if (uniqueTeams.length > 0 && availableTeams.length === 0) {
            availableTeams = uniqueTeams;
            const currentTeam = filterTeam.value;
            filterTeam.innerHTML = '<option value="">All Teams</option>';
            availableTeams.forEach(team => {
              const opt = document.createElement('option');
              opt.value = team;
              opt.textContent = team;
              filterTeam.appendChild(opt);
            });
            filterTeam.value = currentTeam;
          }
        }
        
        // Update live indicator (only if data available from real-time endpoint)
        if (data.watching !== undefined) {
          document.getElementById('live-status').textContent = data.watching 
            ? `LIVE ¬∑ Block ${data.lastCheckedBlock || '?'}` 
            : 'Offline';
          document.getElementById('cache-status').textContent = `${data.floorCacheSize || 0} floors cached`;
          document.getElementById('live-dot').style.background = data.watching ? '#22c55e' : '#ef4444';
        } else {
          // For historical data, show that it's recent listings
          document.getElementById('live-status').textContent = 'Recent Listings';
          document.getElementById('cache-status').textContent = `${listings.length} listings loaded`;
          document.getElementById('live-dot').style.background = '#6b7280';
        }

        isLoadingListings = false;
        
        console.log('[Sniper] About to render listings:', listings.length);
        renderListings();
        
        const timestamp = new Date().toLocaleTimeString();
        const totalCount = data.total || data.count || listings.length;
        statusEl.textContent = `${timestamp} ‚Ä¢ ${totalCount} listings, ${dealsCount} deals`;
        statusEl.className = dealsCount > 0 ? 'success' : '';
        
        console.log('[Sniper] Render complete, listings array length:', listings.length);
        
        // If there's a pending refresh, trigger it now
        if (pendingRefresh) {
          pendingRefresh = false;
          setTimeout(() => fetchListings(), 100);
        }

      } catch (err) {
        console.error('Error fetching listings:', err);
        isLoadingListings = false;
        
        // Only show error message if it's not a timeout during auto-refresh
        // (timeouts during auto-refresh are expected if server is slow)
        const isAutoRefresh = autoRefreshCheckbox && autoRefreshCheckbox.checked;
        const isTimeout = err.message && err.message.includes('timed out');
        
        if (!isAutoRefresh || !isTimeout) {
          statusEl.textContent = 'Error: ' + err.message;
          statusEl.className = 'error';
        } else {
          // Silently handle timeout during auto-refresh
          statusEl.textContent = 'Refreshing...';
          statusEl.className = '';
        }
        
        document.getElementById('live-dot').style.background = '#ef4444';
        // Still render even on error (will show empty state)
        renderListings();
        
        // If there's a pending refresh, trigger it now (after a delay)
        if (pendingRefresh) {
          pendingRefresh = false;
          setTimeout(() => fetchListings(), 1000);
        }
      } finally {
        btnRefresh.classList.remove('loading');
      }
    }
    
    // Warmup on load
    warmupCache();

    // Filter and sort
    function getFilteredListings() {
      let filtered = [...listings];

      // Status filter (sold/unlisted)
      const statusFilter = filterStatus.value;
      if (statusFilter === 'active') {
        filtered = filtered.filter(l => !l.isSold && !l.isUnlisted);
      } else if (statusFilter === 'sold') {
        filtered = filtered.filter(l => l.isSold);
      } else if (statusFilter === 'unlisted') {
        filtered = filtered.filter(l => l.isUnlisted);
      } else if (statusFilter === 'sold-unlisted') {
        filtered = filtered.filter(l => l.isSold || l.isUnlisted);
      }
      // 'all' shows everything (no filter applied)

      // Deals only filter
      const dealsOnly = filterDealsOnly.value;
      if (dealsOnly === 'deals') {
        filtered = filtered.filter(l => l.dealPercent > 0);
      }

      // Min discount filter
      const minDiscount = parseFloat(filterMinDiscount.value);
      if (minDiscount) {
        filtered = filtered.filter(l => (l.dealPercent || 0) >= minDiscount);
      }

      // Owned status filter
      const ownedFilter = filterOwned.value;
      if (ownedFilter === 'owned') {
        filtered = filtered.filter(l => {
          const count = getOwnedCount(l.editionId);
          return count && count > 0;
        });
      } else if (ownedFilter === 'not-owned') {
        filtered = filtered.filter(l => {
          const count = getOwnedCount(l.editionId);
          return !count || count === 0;
        });
      }

      // Tier filter
      const tier = filterTier.value;
      if (tier) {
        filtered = filtered.filter(l => l.tier?.toUpperCase() === tier);
      }

      // Max listing price
      const maxPrice = parseFloat(filterMaxPrice.value);
      if (maxPrice) {
        filtered = filtered.filter(l => (l.listingPrice || 0) <= maxPrice);
      }

      // Max serial
      const maxSerial = parseInt(filterMaxSerial.value);
      if (maxSerial) {
        filtered = filtered.filter(l => (l.serialNumber || Infinity) <= maxSerial);
      }

      // Player search
      const playerSearch = filterPlayer.value.toLowerCase().trim();
      if (playerSearch) {
        filtered = filtered.filter(l => 
          l.playerName?.toLowerCase().includes(playerSearch)
        );
      }

      // Team filter
      const team = filterTeam.value;
      if (team) {
        filtered = filtered.filter(l => l.teamName?.includes(team));
      }

      // Marketplace filter
      const marketplace = filterMarketplace.value;
      if (marketplace && marketplace !== 'all') {
        filtered = filtered.filter(l => l.marketplace === marketplace);
      }

      // Sort
      const sort = sortBy.value;
      filtered.sort((a, b) => {
        switch (sort) {
          case 'deal-desc':
            return (b.dealPercent || -999) - (a.dealPercent || -999);
          case 'price-asc':
            return (a.listingPrice || Infinity) - (b.listingPrice || Infinity);
          case 'price-desc':
            return (b.listingPrice || 0) - (a.listingPrice || 0);
          case 'serial-asc':
            return (a.serialNumber || Infinity) - (b.serialNumber || Infinity);
          case 'time-desc':
            return new Date(b.listedAt || 0) - new Date(a.listedAt || 0);
          default:
            return 0;
        }
      });

      // Update filtered count
      document.getElementById('stat-filtered').textContent = filtered.length;

      return filtered;
    }

    // Get team abbreviation
    function getTeamAbbrev(teamName) {
      const abbrevs = {
        "Arizona Cardinals": "ARI", "Atlanta Falcons": "ATL", "Baltimore Ravens": "BAL", "Buffalo Bills": "BUF",
        "Carolina Panthers": "CAR", "Chicago Bears": "CHI", "Cincinnati Bengals": "CIN", "Cleveland Browns": "CLE",
        "Dallas Cowboys": "DAL", "Denver Broncos": "DEN", "Detroit Lions": "DET", "Green Bay Packers": "GB",
        "Houston Texans": "HOU", "Indianapolis Colts": "IND", "Jacksonville Jaguars": "JAX", "Kansas City Chiefs": "KC",
        "Las Vegas Raiders": "LV", "Los Angeles Chargers": "LAC", "Los Angeles Rams": "LAR", "Miami Dolphins": "MIA",
        "Minnesota Vikings": "MIN", "New England Patriots": "NE", "New Orleans Saints": "NO", "New York Giants": "NYG",
        "New York Jets": "NYJ", "Philadelphia Eagles": "PHI", "Pittsburgh Steelers": "PIT", "San Francisco 49ers": "SF",
        "Seattle Seahawks": "SEA", "Tampa Bay Buccaneers": "TB", "Tennessee Titans": "TEN", "Washington Commanders": "WAS"
      };
      return abbrevs[teamName] || teamName?.substring(0, 3).toUpperCase() || '???';
    }

    // Render listings
    function renderListings() {
      console.log('[Sniper renderListings] Called, isLoading:', isLoadingListings, 'listings count:', listings?.length || 0, 'type:', typeof listings);
      const mobileListings = document.getElementById('mobile-listings');
      
      // Ensure listings is an array
      if (!Array.isArray(listings)) {
        console.error('[Sniper renderListings] listings is not an array!', typeof listings, listings);
        listings = [];
      }
      
      // If listings are currently being loaded, show loading state
      if (isLoadingListings && listings.length === 0) {
        listingsGrid.innerHTML = `
          <div class="empty-state" style="grid-column: 1/-1;">
            <div class="icon">‚è≥</div>
            <h3>Loading listings...</h3>
            <p>Fetching recent listings from the last 6 hours</p>
          </div>
        `;
        tableBody.innerHTML = `
          <tr><td colspan="14" style="text-align: center; padding: 40px; color: #6b7280;">
            <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
              <span>‚è≥</span>
              <span>Loading listings...</span>
            </div>
          </td></tr>
        `;
        if (mobileListings) {
          mobileListings.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #6b7280;">
              ‚è≥ Loading listings...
            </div>
          `;
        }
        return;
      }
      
      const filtered = getFilteredListings();
      const total = filtered.length;
      const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
      
      // Update current page if it's out of bounds
      currentPage = Math.max(1, Math.min(currentPage, totalPages));
      
      // Get the slice for current page
      const start = (currentPage - 1) * PAGE_SIZE;
      const end = Math.min(start + PAGE_SIZE, total);
      const pageListings = filtered.slice(start, end);

      if (filtered.length === 0) {
        listingsGrid.innerHTML = `
          <div class="empty-state" style="grid-column: 1/-1;">
            <div class="icon">üîç</div>
            <h3>No listings found</h3>
            <p>Try adjusting your filters or check back soon</p>
          </div>
        `;
        tableBody.innerHTML = `
          <tr><td colspan="14" style="text-align: center; padding: 40px; color: #6b7280;">
            No listings match your filters
          </td></tr>
        `;
        mobileListings.innerHTML = `
          <div style="text-align: center; padding: 40px; color: #6b7280;">
            üîç No listings match your filters
          </div>
        `;
        return;
      }

      // Grid view
      listingsGrid.innerHTML = pageListings.map(l => {
        // Gold serial only if #1 or matches jersey number
        const isSpecialSerial = l.serialNumber === 1 || (l.jerseyNumber && l.serialNumber === l.jerseyNumber);
        const soldClass = l.isSold ? 'listing-sold' : (l.isUnlisted ? 'listing-unlisted' : '');
        const ownedCount = getOwnedCount(l.editionId);
        const ownedBadge = ownedCount 
          ? `<span style="display: inline-block; margin-left: 0.5rem; padding: 0.15rem 0.5rem; border-radius: 999px; font-size: 0.7rem; font-weight: 600; background: rgba(111, 66, 193, 0.25); color: #0dcaf0; border: 1px solid rgba(13, 202, 240, 0.3);" title="You own ${ownedCount} of this moment">x${ownedCount}</span>`
          : '';

        const marketplaceBadge = l.marketplace === 'flowty' 
          ? `<div style="position: absolute; top: 8px; right: 8px; padding: 4px 8px; background: rgba(139, 92, 246, 0.9); color: white; border-radius: 4px; font-size: 0.65rem; font-weight: 700; text-transform: uppercase; z-index: 5;">Flowty</div>`
          : l.marketplace === 'nflad'
          ? `<div style="position: absolute; top: 8px; right: 8px; padding: 4px 8px; background: rgba(59, 130, 246, 0.9); color: white; border-radius: 4px; font-size: 0.65rem; font-weight: 700; text-transform: uppercase; z-index: 5;">NFLAD</div>`
          : '';
        
        return `
          <div class="listing-card ${soldClass}">
            <div class="card-image">
              ${marketplaceBadge}
              ${isSpecialSerial ? `
                <div class="serial-badge low-serial">#${l.serialNumber}</div>
              ` : `
                <div class="serial-badge">#${l.serialNumber || '?'}</div>
              `}
              
              <div style="color: #4b5563; font-size: 3rem;">üèà</div>
              
              <div class="tier-badge ${getTierClass(l.tier)}">${l.tier || 'Unknown'}</div>
            </div>
            
            <div class="card-body">
              <h3 class="player-name">${l.playerName || 'Unknown Player'}${ownedBadge}</h3>
              <div class="play-info">
                <span>üìç ${l.teamName || 'Unknown'}</span>
                ${l.setName ? `<span>üì¶ ${l.setName}</span>` : ''}
              </div>
              
              <div class="price-section">
                <div class="price-box listing">
                  <div class="price-label">Price</div>
                  <div class="price-value">${formatPrice(l.listingPrice)}</div>
                </div>
                ${l.isSold && l.buyerName ? `
                <div class="price-box floor">
                  <div class="price-label">Buyer</div>
                  <div class="price-value" style="font-size: 0.9rem; color: #9ca3af;">${l.buyerName || l.buyerAddr || '-'}</div>
                </div>
                ` : `
                <div class="price-box floor">
                  <div class="price-label">Floor</div>
                  <div class="price-value">${formatPrice(l.floor)}</div>
                </div>
                `}
              </div>
              
              <div class="time-badge">
                ‚è±Ô∏è ${formatTimeAgo(l.listedAt)}
              </div>
            </div>
            
            <a href="${l.listingUrl || '#'}" target="_blank" class="btn-snipe" style="${l.isSold ? 'background: #6b7280; opacity: 0.7;' : (l.isUnlisted ? 'background: #9ca3af; opacity: 0.7;' : '')}">
              ${l.isSold ? '‚úÖ SOLD' : (l.isUnlisted ? '‚ùå DELISTED' : 'üéØ Snipe')}
            </a>
          </div>
        `;
      }).join('');

      // Table view - all listings with deal highlighting (Desktop)
      tableBody.innerHTML = pageListings.map(l => {
        const isDeal = l.dealPercent > 0;
        const isHotDeal = l.dealPercent >= 15;
        const isGoodDeal = l.dealPercent >= 5;
        const isOverpriced = l.dealPercent < 0;
        
        // Gold serial only if #1 or matches jersey number
        const isSpecialSerial = l.serialNumber === 1 || (l.jerseyNumber && l.serialNumber === l.jerseyNumber);
        
        // Row background
        let rowBg = '';
        if (isHotDeal) rowBg = 'background: rgba(34, 197, 94, 0.2);';
        else if (isGoodDeal) rowBg = 'background: rgba(34, 197, 94, 0.1);';
        else if (isDeal) rowBg = 'background: rgba(34, 197, 94, 0.05);';
        else if (isOverpriced) rowBg = 'background: rgba(239, 68, 68, 0.05);';
        
        // Deal display
        let dealDisplay = '‚Äî';
        let dealColor = '#6b7280';
        if (l.dealPercent > 0) {
          dealDisplay = `‚Üì${l.dealPercent.toFixed(1)}%`;
          dealColor = isHotDeal ? '#22c55e' : isGoodDeal ? '#4ade80' : '#86efac';
        } else if (l.dealPercent < 0) {
          dealDisplay = `‚Üë${Math.abs(l.dealPercent).toFixed(1)}%`;
          dealColor = '#ef4444';
        } else if (l.floor) {
          dealDisplay = '=';
          dealColor = '#6b7280';
        }
        
        // Button style
        let btnBg = '#3b82f6';
        let btnText = 'View';
        if (l.isSold) { btnBg = '#6b7280'; btnText = '‚úÖ SOLD'; }
        else if (l.isUnlisted) { btnBg = '#9ca3af'; btnText = '‚ùå DELISTED'; }
        else if (isHotDeal) { btnBg = '#22c55e'; btnText = 'üî• SNIPE!'; }
        else if (isDeal) { btnBg = '#4ade80'; btnText = '‚ö° BUY'; }
        
        const soldClass = l.isSold ? 'listing-sold' : (l.isUnlisted ? 'listing-unlisted' : '');
        
        // Get owned count
        const ownedCount = getOwnedCount(l.editionId);
        const ownedDisplay = ownedCount 
          ? `<span class="duplicate-count" title="You own ${ownedCount} of this moment" style="display: inline-block; padding: 0.15rem 0.5rem; border-radius: 999px; font-size: 0.75rem; font-weight: 600; background: rgba(111, 66, 193, 0.25); color: #0dcaf0; border: 1px solid rgba(13, 202, 240, 0.3);">${ownedCount}</span>`
          : '<span style="color: #6b7280;">‚Äî</span>';
        
        return `
          <tr class="${soldClass}" style="${rowBg}">
            <td>
              <strong>${l.playerName || 'Unknown'}</strong>
              <div style="font-size: 0.75rem; color: #6b7280;">${l.teamName || ''}</div>
            </td>
            <td style="text-align: center;">${ownedDisplay}</td>
            <td><span class="tier-badge ${getTierClass(l.tier)}" style="font-size: 0.7rem;">${l.tier || '?'}</span></td>
            <td style="font-family: 'JetBrains Mono', monospace; ${isSpecialSerial ? 'color: #fbbf24; font-weight: 600;' : 'color: #9ca3af;'}">#${l.serialNumber || '?'}</td>
            <td style="font-family: 'JetBrains Mono', monospace; color: ${isDeal ? '#22c55e' : '#9ca3af'}; font-weight: 700;">${formatPrice(l.listingPrice)}</td>
            <td style="font-family: 'JetBrains Mono', monospace; color: #9ca3af;">${formatPrice(l.floor)}</td>
            <td style="font-family: 'JetBrains Mono', monospace; color: #9ca3af;">${formatPrice(l.avgSale)}</td>
            <td style="font-family: 'JetBrains Mono', monospace; color: ${dealColor}; font-weight: 600;">${dealDisplay}</td>
            <td style="font-size: 0.8rem; color: #9ca3af;">${l.seriesName || '-'}</td>
            <td style="font-size: 0.8rem; color: #9ca3af;">${l.setName || '-'}</td>
            <td style="font-size: 0.8rem; max-width: 100px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${l.sellerName || ''}">${l.sellerName || '-'}</td>
            <td style="font-size: 0.8rem; max-width: 100px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${l.buyerName || l.buyerAddr || ''}">${l.isSold ? (l.buyerName || l.buyerAddr || '-') : (l.isUnlisted ? '‚Äî' : '-')}</td>
            <td style="color: #6b7280; font-size: 0.85rem;">${formatTimeAgo(l.listedAt)}</td>
            <td>
              <a href="${l.listingUrl || '#'}" target="_blank" 
                 style="background: ${btnBg}; color: ${(l.isSold || l.isUnlisted) ? '#fff' : (isDeal ? '#000' : '#fff')}; padding: 8px 14px; border-radius: 6px; text-decoration: none; font-size: 0.75rem; font-weight: 700; white-space: nowrap; display: inline-block;">
                ${btnText}
              </a>
            </td>
          </tr>
        `;
      }).join('');

      // Mobile card view
      mobileListings.innerHTML = pageListings.map(l => {
        const isDeal = l.dealPercent > 0;
        const isHotDeal = l.dealPercent >= 15;
        // Gold serial only if #1 or matches jersey number
        const isSpecialSerial = l.serialNumber === 1 || (l.jerseyNumber && l.serialNumber === l.jerseyNumber);
        const tierClass = getTierClass(l.tier);
        const teamAbbrev = getTeamAbbrev(l.teamName);
        
        // Deal display
        let dealDisplay = '';
        let dealClass = 'neutral';
        if (l.dealPercent > 0) {
          dealDisplay = `‚Üì${l.dealPercent.toFixed(0)}%`;
          dealClass = 'positive';
        } else if (l.dealPercent < 0) {
          dealDisplay = `‚Üë${Math.abs(l.dealPercent).toFixed(0)}%`;
          dealClass = 'negative';
        }
        
        // Card class
        let cardClass = 'mobile-card';
        if (l.isSold) cardClass += ' listing-sold';
        else if (l.isUnlisted) cardClass += ' listing-unlisted';
        else if (isHotDeal) cardClass += ' is-hot-deal';
        else if (isDeal) cardClass += ' is-deal';
        
        // Get owned count
        const ownedCount = getOwnedCount(l.editionId);
        const ownedBadge = ownedCount 
          ? `<span style="display: inline-block; margin-left: 0.5rem; padding: 0.15rem 0.5rem; border-radius: 999px; font-size: 0.7rem; font-weight: 600; background: rgba(111, 66, 193, 0.25); color: #0dcaf0; border: 1px solid rgba(13, 202, 240, 0.3);" title="You own ${ownedCount} of this moment">x${ownedCount}</span>`
          : '';
        
        return `
          <a href="${l.listingUrl || '#'}" target="_blank" class="${cardClass}">
            <div class="mobile-card-icon ${tierClass}">üèà</div>
            <div class="mobile-card-main">
              <div class="mobile-card-header">
                <span class="mobile-card-player">${l.playerName || 'Unknown'}${ownedBadge}</span>
                <span class="mobile-card-team">${teamAbbrev}</span>
                <span class="mobile-card-tier ${tierClass}">${l.tier || '?'}</span>
              </div>
              <div class="mobile-card-details">
                <span class="mobile-card-set">${l.seriesName || 'Unknown Series'}</span>
                <span class="mobile-card-set">${l.setName || 'Unknown Set'}</span>
                <span class="mobile-card-serial ${isSpecialSerial ? 'low-serial' : ''}">#${l.serialNumber || '?'}</span>
              </div>
            </div>
            <div class="mobile-card-right">
              ${l.isSold ? `
                <div style="color: #6b7280; font-size: 0.9rem; font-weight: 700;">${formatPrice(l.listingPrice)}</div>
                <div style="color: #ef4444; font-size: 0.75rem; font-weight: 600;">‚úÖ SOLD</div>
                ${l.buyerName || l.buyerAddr ? `<div style="font-size: 0.7rem; color: #9ca3af; margin-top: 4px;">Buyer: ${l.buyerName || l.buyerAddr}</div>` : ''}
              ` : l.isUnlisted ? `
                <div style="color: #6b7280; font-size: 0.9rem; font-weight: 700;">${formatPrice(l.listingPrice)}</div>
                <div style="color: #9ca3af; font-size: 0.75rem; font-weight: 600;">‚ùå DELISTED</div>
              ` : `
                <div class="mobile-card-price" style="color: ${isDeal ? '#22c55e' : '#9ca3af'};">${formatPrice(l.listingPrice)}</div>
                ${l.avgSale ? `<div style="font-size: 0.7rem; color: #9ca3af; font-family: 'JetBrains Mono', monospace;">ASP: ${formatPrice(l.avgSale)}</div>` : ''}
                ${dealDisplay ? `<div class="mobile-card-deal ${dealClass}">${dealDisplay}</div>` : ''}
              `}
            </div>
          </a>
        `;
      }).join('');
      
      // Update pagination controls
      const pagerInfo = document.getElementById('sniper-page-info');
      const pagerPrev = document.getElementById('sniper-page-prev');
      const pagerNext = document.getElementById('sniper-page-next');
      
      if (pagerInfo) {
        const from = total ? start + 1 : 0;
        const to = end;
        pagerInfo.textContent = `Page ${currentPage} of ${totalPages} ‚Ä¢ showing ${from}-${to} of ${total}`;
      }
      if (pagerPrev) {
        pagerPrev.disabled = currentPage <= 1;
      }
      if (pagerNext) {
        pagerNext.disabled = currentPage >= totalPages;
      }
    }

    // Auto-refresh every 3 seconds for live sniping
    function startAutoRefresh() {
      if (autoRefreshInterval) clearInterval(autoRefreshInterval);
      
      countdownValue = 5;
      countdownEl.textContent = `${countdownValue}s`;

      autoRefreshInterval = setInterval(() => {
        if (!autoRefreshCheckbox.checked) {
          clearInterval(autoRefreshInterval);
          countdownEl.textContent = 'off';
          return;
        }

        countdownValue--;
        countdownEl.textContent = `${countdownValue}s`;

        if (countdownValue <= 0) {
          // Only trigger if not already loading (prevents stacking)
          if (!isLoadingListings) {
            fetchListings();
          }
          countdownValue = 5; // Increased to 5 seconds to reduce load
        }
      }, 1000);
    }

    // Event listeners
    btnRefresh.addEventListener('click', fetchListings);
    autoRefreshCheckbox.addEventListener('change', () => {
      if (autoRefreshCheckbox.checked) {
        startAutoRefresh();
      } else {
        clearInterval(autoRefreshInterval);
        countdownEl.textContent = 'off';
      }
    });

    // Filter change listeners - reset to page 1 when filters change
    [filterDealsOnly, filterMinDiscount, filterOwned, filterTier, filterMaxPrice, filterMaxSerial, filterPlayer, filterTeam, filterStatus, sortBy].forEach(el => {
      el.addEventListener('change', () => {
        currentPage = 1; // Reset to first page when filters change
        renderListings();
      });
      if (el.tagName === 'INPUT') {
        el.addEventListener('input', () => {
          currentPage = 1; // Reset to first page when filters change
          renderListings();
        });
      }
    });
    
    // Pagination button listeners
    const pagerPrev = document.getElementById('sniper-page-prev');
    const pagerNext = document.getElementById('sniper-page-next');
    if (pagerPrev) {
      pagerPrev.addEventListener('click', () => {
        if (currentPage > 1) {
          currentPage--;
          renderListings();
        }
      });
    }
    if (pagerNext) {
      pagerNext.addEventListener('click', () => {
        const total = getFilteredListings().length;
        const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
        if (currentPage < totalPages) {
          currentPage++;
          renderListings();
        }
      });
    }

    // Table sorting
    document.querySelectorAll('.listings-table th[data-sort]').forEach(th => {
      th.addEventListener('click', () => {
        const key = th.dataset.sort;
        const currentSort = sortBy.value;
        
        // Map table columns to sort values
        const sortMap = {
          'player': 'time-desc', // No direct player sort, use time
          'tier': 'time-desc',
          'serial': 'serial-asc',
          'price': 'price-asc',
          'floor': 'price-asc',
          'asp': 'price-asc', // Use price sort for ASP
          'deal': 'deal-desc',
          'time': 'time-desc'
        };

        if (sortMap[key]) {
          sortBy.value = sortMap[key];
          currentPage = 1; // Reset to first page when sorting changes
          renderListings();
        }
      });
    });

    // Mobile filter toggle
    const filtersToggle = document.getElementById('filters-toggle');
    const filtersCard = document.getElementById('filters-card');
    
    if (filtersToggle && filtersCard) {
      filtersToggle.addEventListener('click', () => {
        filtersCard.classList.toggle('open');
        filtersToggle.classList.toggle('open');
      });
    }

    // Initialize - fetch listings immediately, owned counts in parallel
    fetchListings();
    fetchOwnedCounts(); // Run in parallel, doesn't need to wait
    startAutoRefresh();
  </script>
</body>
</html>

